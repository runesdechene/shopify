{{ 'rdc_fragments.css' | asset_url | stylesheet_tag }}

<div class="rdc-fragments-section" data-section-id="{{ section.id }}">
  <div class="fragments-hero">
    {%- comment -%} Logo/Ic√¥ne en haut {%- endcomment -%}
    <div class="fragments-icon">
      {% if section.settings.icon != blank %}
        {{ section.settings.icon | image_url: width: 100 | image_tag: alt: 'Fragments icon' }}
      {% else %}
        <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M30 5L35 20L50 25L35 30L30 45L25 30L10 25L25 20L30 5Z" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M30 15L32 22L39 24L32 26L30 33L28 26L21 24L28 22L30 15Z" fill="currentColor"/>
        </svg>
      {% endif %}
    </div>

    {%- comment -%} Titre principal {%- endcomment -%}
    <h1 class="fragments-title">
      {{ section.settings.title | default: "FRAGMENTS D'HISTOIRE" }}
    </h1>

    {%- comment -%} Description {%- endcomment -%}
    <p class="fragments-description">
      {{ section.settings.description | default: "D√©couvrez ici la signification, le r√©cit ou l'anecdote qui se cache derri√®re le fragment que vous portez ou comptez porter." }}
    </p>

    {%- comment -%} Barre de recherche {%- endcomment -%}
    <div class="fragments-search">
      <input 
        type="text" 
        class="fragments-search-input" 
        placeholder="{{ section.settings.search_placeholder | default: 'Rechercher un fragment...' }}"
        id="fragments-search-{{ section.id }}"
      >
    </div>

    {%- comment -%} Filtres de cat√©gories (g√©n√©r√©s automatiquement depuis les tags) {%- endcomment -%}
    <div class="fragments-filters">
      <button class="fragments-filter active" data-filter="all">
        ‚ú® Tous les fragments
      </button>
      
      <button class="fragments-filter" data-filter="recent" data-filter-type="date">
        üî• R√©cents
      </button>
      
      {% if section.settings.blog != blank %}
        {%- assign blog = blogs[section.settings.blog] -%}
        {%- assign all_tags = '' -%}
        {%- assign articles_limit = section.settings.articles_count | default: 0 -%}
        
        {%- comment -%} Collecter tous les tags uniques des articles {%- endcomment -%}
        {% for article in blog.articles %}
          {% for tag in article.tags %}
            {%- unless all_tags contains tag -%}
              {%- if all_tags == '' -%}
                {%- assign all_tags = tag -%}
              {%- else -%}
                {%- assign all_tags = all_tags | append: '|' | append: tag -%}
              {%- endif -%}
            {%- endunless -%}
          {% endfor %}
        {% endfor %}
        
        {%- comment -%} Afficher un bouton pour chaque tag unique {%- endcomment -%}
        {%- assign tags_array = all_tags | split: '|' -%}
        {% for tag in tags_array %}
          <button class="fragments-filter" data-filter="{{ tag | handleize }}">
            {{ tag }}
          </button>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  {%- comment -%} Carrousel horizontal scrollable {%- endcomment -%}
  <div class="fragments-carousel-container">
    <div class="fragments-carousel" id="fragments-carousel-{{ section.id }}">
      {%- comment -%} Phase 2: Cartes dynamiques depuis le blog {%- endcomment -%}
      
      {% if section.settings.blog != blank %}
        {%- assign blog = blogs[section.settings.blog] -%}
        {%- assign articles_limit = section.settings.articles_count | default: 0 -%}
        
        {%- comment -%} D√©terminer la limite d'articles (max 50) {%- endcomment -%}
        {% if articles_limit > 0 and articles_limit <= 50 %}
          {%- assign final_limit = articles_limit -%}
        {% else %}
          {%- assign final_limit = 50 -%}
        {% endif %}
        
        {% for article in blog.articles limit: final_limit %}
          {%- assign now_timestamp = 'now' | date: '%s' | plus: 0 -%}
          {%- assign article_timestamp = article.published_at | date: '%s' | plus: 0 -%}
          {%- assign article_age_seconds = now_timestamp | minus: article_timestamp -%}
          {%- assign sixty_days_seconds = 5184000 -%}
          {%- assign is_recent = false -%}
          {%- if article_age_seconds < sixty_days_seconds -%}
            {%- assign is_recent = true -%}
          {%- endif -%}
          
          <div class="fragment-card{% if is_recent %} is-recent{% endif %}" 
               data-index="{{ forloop.index0 }}"
               data-article-id="{{ article.id }}"
               data-article-url="{{ article.url }}"
               data-tags="{{ article.tags | join: ',' }}"
               data-published-at="{{ article.published_at | date: '%s' }}"
               data-excerpt="{{ article.excerpt_or_content | strip_html | truncate: 200 | escape }}">
            
            <div class="fragment-card-inner">
              {%- comment -%} Pastille "Nouveau" pour les articles r√©cents {%- endcomment -%}
              {% if is_recent %}
                <span class="fragment-card-badge">üî• NOUVEAU</span>
              {% endif %}
              
              {%- comment -%} Image de l'article comme fond {%- endcomment -%}
              {% if article.image %}
                <div class="fragment-card-image" style="background-image: url('{{ article.image | image_url: width: 800 }}');"></div>
              {% else %}
                <div class="fragment-card-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
              {% endif %}
              
              <div class="fragment-card-content">
                <p>{{ article.excerpt_or_content | strip_html | truncate: 100 }}</p>
              </div>
            </div>
            
            <h3 class="fragment-card-title">{{ article.title }}</h3>
          </div>
        {% endfor %}
        
      {% else %}
        {%- comment -%} Fallback: Cartes de test si aucun blog n'est s√©lectionn√© {%- endcomment -%}
        <div class="fragment-card" data-index="0">
          <div class="fragment-card-inner">
            <div class="fragment-card-image" style="background: linear-gradient(135deg, #5D6D7E 0%, #34495E 100%);"></div>
            <div class="fragment-card-content">
              <p>S√©lectionnez un blog dans les param√®tres de la section</p>
            </div>
          </div>
          <h3 class="fragment-card-title">Configuration requise</h3>
        </div>
      {% endif %}
    </div>

    {%- comment -%} Contr√¥les de navigation {%- endcomment -%}
    <button class="carousel-nav carousel-nav-prev" aria-label="Pr√©c√©dent">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <button class="carousel-nav carousel-nav-next" aria-label="Suivant">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  {%- comment -%} Zone d'extrait fixe {%- endcomment -%}
  <div class="fragments-excerpt-container">
    <p class="fragments-excerpt" id="fragments-excerpt-{{ section.id }}">
      S√©lectionnez un fragment pour d√©couvrir son histoire...
    </p>
    <p class="fragments-cta">Cliquez sur la carte pour lire</p>
  </div>

  {%- comment -%} Indicateurs g√©n√©r√©s dynamiquement par JavaScript {%- endcomment -%}
  <div class="fragments-indicators" id="fragments-indicators-{{ section.id }}">
    {%- comment -%} Les indicateurs seront g√©n√©r√©s par le JS en fonction du nombre de cartes affich√©es {%- endcomment -%}
  </div>
</div>

<script src="{{ 'rdc_fragments.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "RDC Fragments d'Histoire",
  "tag": "section",
  "class": "section-rdc-fragments",
  "settings": [
    {
      "type": "image_picker",
      "id": "icon",
      "label": "Ic√¥ne (optionnel)"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre principal",
      "default": "FRAGMENTS D'HISTOIRE"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "D√©couvrez ici la signification, le r√©cit ou l'anecdote qui se cache derri√®re le fragment que vous portez ou comptez porter."
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Placeholder de recherche",
      "default": "Rechercher un fragment..."
    },
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog source (Phase 2)"
    },
    {
      "type": "number",
      "id": "articles_count",
      "label": "Nombre d'articles √† afficher (0 = tous)",
      "default": 0,
      "info": "Laissez √† 0 pour afficher tous les articles du blog"
    }
  ],
  "blocks": [
    {
      "type": "filter",
      "name": "Filtre/Tag",
      "settings": [
        {
          "type": "text",
          "id": "filter_label",
          "label": "Libell√© du filtre",
          "default": "Mythologie"
        },
        {
          "type": "text",
          "id": "filter_tag",
          "label": "Tag correspondant",
          "info": "Tag utilis√© pour filtrer les articles"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "RDC Fragments d'Histoire",
      "blocks": [
        {
          "type": "filter",
          "settings": {
            "filter_label": "Mythologie",
            "filter_tag": "mythologie"
          }
        },
        {
          "type": "filter",
          "settings": {
            "filter_label": "√âdda III",
            "filter_tag": "edda-iii"
          }
        },
        {
          "type": "filter",
          "settings": {
            "filter_label": "Sagas islandaises",
            "filter_tag": "sagas-islandaises"
          }
        }
      ]
    }
  ]
}
{% endschema %}
