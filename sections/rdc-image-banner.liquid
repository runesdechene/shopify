{{ 'image-banner-carousel.css' | asset_url | stylesheet_tag }}

<div class="image-banner-carousel" data-section-id="{{ section.id }}">
  <div class="carousel-container">
    <div class="carousel-wrapper">
      <div class="carousel-track" id="carousel-track-{{ section.id }}">
        {% for block in section.blocks %}
          <div class="carousel-slide" {{ block.shopify_attributes }}>
            {% if block.settings.image %}
              <div class="slide-image-container">
                {% assign image_alt = block.settings.image.alt | default: block.settings.heading %}
                <img 
                  src="{{ block.settings.image | image_url: width: 1920 }}"
                  alt="{{ image_alt }}"
                  loading="lazy"
                  width="{{ block.settings.image.width }}"
                  height="{{ block.settings.image.height }}"
                  class="carousel-image"
                >
                
                {% if block.settings.heading != blank or block.settings.text != blank or block.settings.button_label != blank %}
                  <div class="slide-content">
                    <div class="slide-content-inner">
                      {% if block.settings.heading != blank %}
                        <h2 class="slide-heading">{{ block.settings.heading }}</h2>
                      {% endif %}
                      
                      {% if block.settings.text != blank %}
                        <p class="slide-text">{{ block.settings.text }}</p>
                      {% endif %}
                      
                      {% if block.settings.button_label != blank %}
                        <a 
                          href="{{ block.settings.button_link | default: '#' }}" 
                          class="slide-button btn"
                          {% if block.settings.button_link == blank %}aria-disabled="true"{% endif %}
                        >
                          {{ block.settings.button_label }}
                        </a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="slide-placeholder">
                <div class="placeholder-content">
                  <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.5 52.5H52.5V15H37.5L30 7.5H7.5V52.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="22.5" cy="30" r="7.5" stroke="currentColor" stroke-width="2"/>
                    <path d="M37.5 37.5L45 30L52.5 37.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <p>Ajouter une image</p>
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    
    {% if section.blocks.size > 1 %}
      <!-- Navigation arrows -->
      <button class="carousel-nav carousel-nav--prev" id="prev-{{ section.id }}" aria-label="Image précédente">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      
      <button class="carousel-nav carousel-nav--next" id="next-{{ section.id }}" aria-label="Image suivante">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      
      <!-- Dots indicator -->
      <div class="carousel-dots">
        {% for block in section.blocks %}
          <button 
            class="carousel-dot{% if forloop.first %} active{% endif %}" 
            data-slide="{{ forloop.index0 }}"
            aria-label="Aller à l'image {{ forloop.index }}"
          ></button>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const carousel = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!carousel) return;
  
  const track = carousel.querySelector('#carousel-track-{{ section.id }}');
  const slides = carousel.querySelectorAll('.carousel-slide');
  const prevBtn = carousel.querySelector('#prev-{{ section.id }}');
  const nextBtn = carousel.querySelector('#next-{{ section.id }}');
  const dots = carousel.querySelectorAll('.carousel-dot');
  
  let currentSlide = 0;
  const totalSlides = slides.length;
  
  if (totalSlides <= 1) return;
  
  // Auto-play settings
  const autoPlay = {{ section.settings.auto_play | json }};
  const autoPlaySpeed = {{ section.settings.auto_play_speed | times: 1000 | json }};
  let autoPlayInterval;
  
  function updateCarousel() {
    const translateX = -currentSlide * 100;
    track.style.transform = `translateX(${translateX}%)`;
    
    // Update dots
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === currentSlide);
    });
  }
  
  function nextSlide() {
    currentSlide = (currentSlide + 1) % totalSlides;
    updateCarousel();
  }
  
  function prevSlide() {
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    updateCarousel();
  }
  
  function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
  }
  
  // Event listeners
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      nextSlide();
      if (autoPlay) {
        clearInterval(autoPlayInterval);
        startAutoPlay();
      }
    });
  }
  
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      prevSlide();
      if (autoPlay) {
        clearInterval(autoPlayInterval);
        startAutoPlay();
      }
    });
  }
  
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      goToSlide(index);
      if (autoPlay) {
        clearInterval(autoPlayInterval);
        startAutoPlay();
      }
    });
  });
  
  // Auto-play functionality
  function startAutoPlay() {
    if (autoPlay && autoPlaySpeed > 0) {
      autoPlayInterval = setInterval(nextSlide, autoPlaySpeed);
    }
  }
  
  // Pause auto-play on hover
  if (autoPlay) {
    carousel.addEventListener('mouseenter', () => {
      clearInterval(autoPlayInterval);
    });
    
    carousel.addEventListener('mouseleave', () => {
      startAutoPlay();
    });
    
    startAutoPlay();
  }
  
  // Touch/swipe support
  let startX = 0;
  let isDragging = false;
  
  carousel.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    isDragging = true;
  });
  
  carousel.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
  });
  
  carousel.addEventListener('touchend', (e) => {
    if (!isDragging) return;
    
    const endX = e.changedTouches[0].clientX;
    const diffX = startX - endX;
    
    if (Math.abs(diffX) > 50) {
      if (diffX > 0) {
        nextSlide();
      } else {
        prevSlide();
      }
      
      if (autoPlay) {
        clearInterval(autoPlayInterval);
        startAutoPlay();
      }
    }
    
    isDragging = false;
  });
});
</script>

{% schema %}
{
  "name": "rdc-image-banner",
  "tag": "section",
  "class": "section-image-banner-carousel",
  "settings": [
    {
      "type": "header",
      "content": "Paramètres du carrousel"
    },
    {
      "type": "checkbox",
      "id": "auto_play",
      "label": "Défilement automatique",
      "default": true
    },
    {
      "type": "range",
      "id": "auto_play_speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Vitesse de défilement",
      "default": 5
    },
    {
      "type": "range",
      "id": "section_height",
      "min": 300,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Hauteur de la section",
      "default": 500
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Diapositive",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Titre",
          "placeholder": "Titre de la diapositive"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Texte",
          "placeholder": "Description de la diapositive"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Texte du bouton"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Lien du bouton"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Bannière Carrousel",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}
