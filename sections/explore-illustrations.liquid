{{ 'explore-illustrations.css' | asset_url | stylesheet_tag }}
{{ 'explore-illustrations-dark.css' | asset_url | stylesheet_tag }}

{% style %}
  #section-{{ section.id }}.rdc-fragments-section {
    {% if section.settings.background_image != blank %}
      background-image: url('{{ section.settings.background_image | image_url: width: 1920 }}');
    {% else %}
      background-image: url('{{ "explore_fond_default.webp" | asset_url }}');
    {% endif %}
    background-size: cover;
  }

  #section-{{ section.id }} .fragments-title {
    font-size: {{ section.settings.title_size }}px;
    color: {{ section.settings.title_color }};
  }

  #section-{{ section.id }} .fragments-subtitle {
    font-size: {{ section.settings.subtitle_size }}px;
    color: {{ section.settings.subtitle_color }};
  }

  #section-{{ section.id }} .fragment-card-title {
    font-size: {{ section.settings.card_title_size }}px;
    color: {{ section.settings.card_title_color }};
  }

  #section-{{ section.id }} .fragment-card-artist {
    color: {{ section.settings.card_artist_color }};
  }

  #section-{{ section.id }} .fragment-card-summary {
    color: {{ section.settings.card_summary_color }};
  }

  #section-{{ section.id }} .fragment-btn {
    background: {{ section.settings.button_bg_color }};
    color: {{ section.settings.button_text_color }};
    border-radius: {{ section.settings.button_border_radius }}px;
  }

  #section-{{ section.id }} .fragments-back-btn {
    background: {{ section.settings.nav_button_bg }};
    color: {{ section.settings.nav_button_color }};
  }

  @media screen and (max-width: 749px) {
    #section-{{ section.id }} .fragments-title {
      font-size: {{ section.settings.title_size | divided_by: 2 }}px;
    }
    #section-{{ section.id }} .fragments-subtitle {
      font-size: {{ section.settings.subtitle_size | divided_by: 2 }}px;
    }
    #section-{{ section.id }} .fragment-card-title {
      font-size: {{ section.settings.card_title_size | divided_by: 1.5 | round }}px;
    }
  }
{% endstyle %}

{%- comment -%} Récupérer tous les métaobjets du type spécifié {%- endcomment -%}
{%- assign metaobject_handle = section.settings.metaobject_type | default: 'reliques' -%}
{%- assign reliques = shop.metaobjects[metaobject_handle].values -%}

<div id="section-{{ section.id }}" class="rdc-fragments-section section section--{{ section.settings.section_width }}" data-section-id="{{ section.id }}">
  <div class="rdc-fragments-background-actif"></div>
  <div class="fragments-hero">
    {%- comment -%} Bouton de retour {%- endcomment -%}
    {% if section.settings.show_back_button %}
      <a href="{{ section.settings.back_url | default: '/' }}" class="fragments-back-btn" aria-label="Retour">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </a>
    {% endif %}

    {%- comment -%} Compter les artistes uniques {%- endcomment -%}
    {%- assign all_artists = '' -%}
    {% for relique in reliques %}
      {% if relique.artiste.value != blank %}
        {%- assign artist_name = relique.artiste.value.nom.value | strip -%}
        {%- unless all_artists contains artist_name -%}
          {%- if all_artists == '' -%}
            {%- assign all_artists = artist_name -%}
          {%- else -%}
            {%- assign all_artists = all_artists | append: '|' | append: artist_name -%}
          {%- endif -%}
        {%- endunless -%}
      {% endif %}
    {% endfor %}
    {%- assign artists_array = all_artists | split: '|' -%}
    {%- assign artists_count = artists_array.size -%}

    {%- comment -%} Titre et sous-titre alignés à gauche {%- endcomment -%}
    <div class="fragments-header-title">
      <h1 class="fragments-title">
        {{ section.settings.title | default: 'EXPLORER' }}
        <span class="fragments-subtitle">{{ section.settings.subtitle | default: 'NOS CRÉATIONS' }}</span>
      </h1>

      <p class="fragments-meta">
        {{ reliques.size }} illustrations disponibles, {{ artists_count }} artiste{% if artists_count > 1 %}s{% endif %}
      </p>
    </div>

    {%- comment -%} Filtres de catégories personnalisés (en haut à droite) {%- endcomment -%}
    {% if section.settings.show_filters %}
    <div class="fragments-filters">
      <button class="fragments-filter active" data-filter="all">{{ section.settings.filter_all_label }}</button>

      {%- comment -%} Collecter tous les tags uniques depuis les metaobjects {%- endcomment -%}
      {%- assign all_tags = '' -%}
      {% for relique in reliques %}
        {% if relique.tags != blank %}
          {% for tag in relique.tags.value %}
            {%- assign clean_tag = tag | strip -%}
            {%- unless all_tags contains clean_tag -%}
              {%- if all_tags == '' -%}
                {%- assign all_tags = clean_tag -%}
              {%- else -%}
                {%- assign all_tags = all_tags | append: '|' | append: clean_tag -%}
              {%- endif -%}
            {%- endunless -%}
          {% endfor %}
        {% endif %}
      {% endfor %}

      {%- comment -%} Afficher un bouton pour chaque tag unique {%- endcomment -%}
      {%- assign tags_array = all_tags | split: '|' -%}
      {% for tag in tags_array %}
        <button class="fragments-filter" data-filter="{{ tag | handleize }}">
          {{ tag }}
        </button>
      {% endfor %}
    </div>
    {% endif %}

    {%- comment -%} Bouton toggle thème sombre {%- endcomment -%}
    <div class="theme-toggle-container">
      <button class="theme-toggle" id="theme-toggle-{{ section.id }}" aria-label="Basculer le thème">
        <svg
          class="theme-icon sun-icon"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg
          class="theme-icon moon-icon"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <span class="theme-toggle-slider"></span>
      </button>
    </div>

    {%- comment -%} Barre de recherche {%- endcomment -%}
    <div class="fragments-search">
      <input
        type="text"
        class="fragments-search-input"
        placeholder="{{ section.settings.search_placeholder | default: 'Rechercher un fragment...' }}"
        id="fragments-search-{{ section.id }}"
      >
    </div>
  </div>

  {%- comment -%} Carrousel horizontal scrollable {%- endcomment -%}
  <div class="fragments-carousel-container">
    <div class="fragments-carousel" id="fragments-carousel-{{ section.id }}">
      {%- comment -%} Cartes depuis les metaobjects Reliques {%- endcomment -%}

      {% if reliques.size > 0 %}
        {% for relique in reliques %}
          {%- comment -%} Convertir la liste de tags en chaîne {%- endcomment -%}
          {%- assign tags_string = '' -%}
          {% if relique.tags != blank %}
            {% for tag in relique.tags.value %}
              {%- if forloop.first -%}
                {%- assign tags_string = tag -%}
              {%- else -%}
                {%- assign tags_string = tags_string | append: ', ' | append: tag -%}
              {%- endif -%}
            {% endfor %}
          {% endif %}

          {%- comment -%} Récupérer l'URL et la date de l'article {%- endcomment -%}
          {%- assign article_url = '' -%}
          {%- assign article_published_at = '' -%}
          {%- if relique.recit != blank -%}
            {%- if relique.recit.url -%}
              {%- assign article_url = relique.recit.url -%}
              {%- assign article_published_at = relique.recit.published_at -%}
            {%- elsif relique.recit.value.url -%}
              {%- assign article_url = relique.recit.value.url -%}
              {%- assign article_published_at = relique.recit.value.published_at -%}
            {%- elsif relique.recit -%}
              {%- assign article_url = relique.recit -%}
            {%- endif -%}
          {%- endif -%}

          {%- comment -%} Récupérer la collection reliée au métaobjet {%- endcomment -%}
          {%- assign product_count = 0 -%}
          {%- assign collection_url = '' -%}
          {%- if relique.collection != blank -%}
            {%- if relique.collection.value -%}
              {%- assign linked_collection = relique.collection.value -%}
              {%- assign product_count = linked_collection.products.size -%}
              {%- assign collection_url = linked_collection.url -%}
            {%- elsif relique.collection.url -%}
              {%- assign collection_url = relique.collection.url -%}
              {%- assign product_count = relique.collection.products.size -%}
            {%- endif -%}
          {%- endif -%}

          <div
            class="fragment-card"
            data-index="{{ forloop.index0 }}"
            data-block-id="{{ relique.id }}"
            data-card-title="{{ relique.nom }}"
            data-filter-gid="{{ relique.filter_gid }}"
            data-excerpt="{{ relique.description | metafield_text | strip_html | truncate: 200 | escape }}"
            data-tags="{{ tags_string }}"
            data-article-url="{{ article_url }}"
            data-article-published-at="{{ article_published_at }}"
            data-fragment-date="{{ relique.date }}"
            data-product-count="{{ product_count }}"
            data-collection-url="{{ collection_url }}"
            data-debug-recit="{{ relique.recit }}"
            data-background-image="{% if relique.image_fond_de_fragment != blank %}{{ relique.image_fond_de_fragment | image_url: width: 1920 }}{% endif %}"
          >
            <div class="fragment-card-wrapper">
              {%- comment -%} Image en haut {%- endcomment -%}
              <div class="fragment-card-image-col">
                {% if relique.image_pour_fond_clair != blank or relique.image_pour_fond_sombre != blank %}
                  <img
                    src="{{ relique.image_pour_fond_clair | image_url: width: 600 }}"
                    alt="{{ relique.nom }}"
                    class="fragment-image"
                    data-light-image="{{ relique.image_pour_fond_clair | image_url: width: 600 }}"
                    data-dark-image="{{ relique.image_pour_fond_sombre | image_url: width: 600 }}"
                  >
                {% else %}
                  <div class="fragment-image-placeholder"></div>
                {% endif %}
              </div>

              {%- comment -%} Infos sous l'image : Titre, Artiste, Résumé {%- endcomment -%}
              <div class="fragment-card-content-col">
                <h2 class="fragment-card-title">{{ relique.nom | default: "Titre de l'illustration" }}</h2>

                {% if relique.artiste.value != blank %}
                  <p class="fragment-card-artist">
                    Artiste : {{ relique.artiste.value.nom.value }}
                    {% if relique.date != blank %}
                      <!-- ({{ relique.date | date: '%Y' }}) -->
                    {% endif %}
                  </p>
                {% endif %}

                {% if relique.resume != blank %}
                  <p class="fragment-card-summary">
                    « {{ relique.resume }} »
                  </p>
                {% endif %}

                {%- comment -%} Badge NOUVEAU (sera géré par JS) {%- endcomment -%}
                <div class="fragment-new-badge" style="display: none;">
                  <img src="{{ 'explore-new_badge.png' | asset_url }}">
                </div>
              </div>
            </div>
          </div>
        {% endfor %}

      {% else %}
        {%- comment -%} Fallback: Carte de test si aucun metaobject n'existe {%- endcomment -%}
        <div class="fragment-card" data-index="0">
          <div class="fragment-card-wrapper">
            <div class="fragment-card-image-col">
              <div class="fragment-image-placeholder"></div>
            </div>
            <div class="fragment-card-content-col">
              <h3 class="fragment-card-title">Aucune illustration</h3>
              <p>Créez des metaobjects de type "Reliques" pour afficher des illustrations</p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    {%- comment -%} Contrôles de navigation {%- endcomment -%}
    <button class="carousel-nav carousel-nav-prev" aria-label="Précédent">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <button class="carousel-nav carousel-nav-next" aria-label="Suivant">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  {%- comment -%} Compteur de cartes {%- endcomment -%}
  <div class="fragments-counter" id="fragments-counter-{{ section.id }}">
    <span class="counter-current">1</span> / <span class="counter-total">{{ reliques.size }}</span>
  </div>

  {%- comment -%} Bouton d'action double fixe {%- endcomment -%}
  <div class="fragments-fixed-actions" id="fragments-fixed-actions-{{ section.id }}">
    <button type="button" class="fragment-btn" data-action="shop">Découvrir les produits</button>
  </div>

  {%- comment -%} Images de décoration en bas {%- endcomment -%}
  {%- assign opacity_value = section.settings.bottom_images_opacity | default: 100 | divided_by: 100.0 -%}
  <div class="bottom-decoration-images" style="opacity: {{ opacity_value }};">
    {% if section.settings.bottom_image_left != blank %}
      <img
        src="{{ section.settings.bottom_image_left | image_url: width: 400 }}"
        alt="Décoration gauche"
        class="bottom-image bottom-image-left"
      >
    {% endif %}

    {% if section.settings.bottom_image_center != blank %}
      <img
        src="{{ section.settings.bottom_image_center | image_url: width: 1920 }}"
        alt="Décoration centre"
        class="bottom-image bottom-image-center"
      >
    {% endif %}

    {% if section.settings.bottom_image_right != blank %}
      <img
        src="{{ section.settings.bottom_image_right | image_url: width: 400 }}"
        alt="Décoration droite"
        class="bottom-image bottom-image-right"
      >
    {% endif %}
  </div>
</div>

<script src="{{ 'explore-illustrations.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Explorer : Illustrations",
  "tag": "section",
  "class": "section-explore-illustrations",
  "settings": [
    {
      "type": "header",
      "content": "Source des données"
    },
    {
      "type": "text",
      "id": "metaobject_type",
      "label": "Type de métaobjet",
      "info": "Handle du métaobjet à afficher (ex: reliques, artistes, collections_speciales)",
      "default": "reliques"
    },
    {
      "type": "header",
      "content": "Mise en page"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Largeur de la section",
      "options": [
        {
          "value": "page-width",
          "label": "Page"
        },
        {
          "value": "full-width",
          "label": "Pleine largeur"
        }
      ],
      "default": "full-width"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Schéma de couleurs",
      "default": "scheme-1"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Image de fond"
    },
    {
      "type": "header",
      "content": "Titre et sous-titre"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre principal",
      "default": "EXPLORER"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 24,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Taille du titre (desktop)",
      "default": 96
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Couleur du titre",
      "default": "#635e4c"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Sous-titre",
      "default": "NOS CRÉATIONS"
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "min": 16,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "Taille du sous-titre (desktop)",
      "default": 48
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Couleur du sous-titre",
      "default": "#a39b8c"
    },
    {
      "type": "header",
      "content": "Cartes"
    },
    {
      "type": "range",
      "id": "card_title_size",
      "min": 16,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "Taille du titre des cartes",
      "default": 40
    },
    {
      "type": "color",
      "id": "card_title_color",
      "label": "Couleur du titre des cartes",
      "default": "#494141"
    },
    {
      "type": "color",
      "id": "card_artist_color",
      "label": "Couleur de l'artiste",
      "default": "#796e6d"
    },
    {
      "type": "color",
      "id": "card_summary_color",
      "label": "Couleur du résumé",
      "default": "#665f56"
    },
    {
      "type": "header",
      "content": "Bouton d'action"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Texte du bouton",
      "default": "Découvrir les produits"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Couleur de fond du bouton",
      "default": "#6d1e1e"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Couleur du texte du bouton",
      "default": "#e9e4e4"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Arrondi du bouton",
      "default": 50
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "checkbox",
      "id": "show_back_button",
      "label": "Afficher le bouton retour",
      "default": true
    },
    {
      "type": "url",
      "id": "back_url",
      "label": "URL du bouton retour",
      "default": "/"
    },
    {
      "type": "color",
      "id": "nav_button_bg",
      "label": "Couleur de fond des boutons navigation",
      "default": "#e6dcc7"
    },
    {
      "type": "color",
      "id": "nav_button_color",
      "label": "Couleur des icônes navigation",
      "default": "#5e5444"
    },
    {
      "type": "header",
      "content": "Filtres"
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "Afficher les filtres",
      "default": true
    },
    {
      "type": "text",
      "id": "filter_all_label",
      "label": "Libellé du filtre 'Tous'",
      "default": "✨ Toutes les reliques"
    },
    {
      "type": "header",
      "content": "Images de décoration"
    },
    {
      "type": "image_picker",
      "id": "bottom_image_left",
      "label": "Image décoration bas gauche"
    },
    {
      "type": "image_picker",
      "id": "bottom_image_center",
      "label": "Image décoration bas centre (pleine largeur)"
    },
    {
      "type": "image_picker",
      "id": "bottom_image_right",
      "label": "Image décoration bas droite"
    },
    {
      "type": "range",
      "id": "bottom_images_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Opacité des images de décoration",
      "default": 100
    }
  ],
  "presets": [
    {
      "name": "Explorer : Illustrations"
    }
  ]
}
{% endschema %}
