{%- comment -%}
  RDC Classic Product Gallery
  
  Clean, classic product gallery with main image on top and thumbnail navigation below.
  Similar to the reference design provided.
{%- endcomment -%}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<style>
  .rdc-classic-gallery {
    width: 100%;
  }

  .rdc-classic-gallery__main {
    width: 100%;
    margin-bottom: 1.5rem;
    background-color: #EEEDE6;
    border-radius: 8px;
    overflow: hidden;
  }

  .rdc-classic-gallery__main-image {
    display: none;
  }

  .rdc-classic-gallery__main-image.active {
    display: block;
  }

  .rdc-classic-gallery__main-image.hidden-by-filter {
    display: none !important;
  }

  .rdc-classic-gallery__main-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .rdc-classic-gallery__thumbnails {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  .rdc-classic-gallery__thumbnail {
    aspect-ratio: 1;
    background-color: #EEEDE6;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.3s ease;
    border: 2px solid transparent;
  }

  .rdc-classic-gallery__thumbnail.hidden-by-filter {
    display: none;
  }

  .rdc-classic-gallery__thumbnail:hover {
    opacity: 0.9;
  }

  .rdc-classic-gallery__thumbnail.active {
    opacity: 1;
    border-color: #534f4f;
  }

  .rdc-classic-gallery__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media (max-width: 767px) {
    .rdc-classic-gallery__thumbnails {
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
  }

  @media (max-width: 480px) {
    .rdc-classic-gallery__thumbnails {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<div class="rdc-classic-gallery" id="RdcClassicGallery-{{ section.id }}">
  {%- comment -%} Main image area {%- endcomment -%}
  <div class="rdc-classic-gallery__main">
    {%- for media in product.media -%}
      {%- if media.media_type == 'image' -%}
        {%- comment -%} Get variant IDs associated with this image {%- endcomment -%}
        {%- assign variant_ids = '' -%}
        {%- for variant in product.variants -%}
          {%- if variant.featured_media.id == media.id -%}
            {%- if variant_ids == '' -%}
              {%- assign variant_ids = variant.id | append: '' -%}
            {%- else -%}
              {%- assign variant_ids = variant_ids | append: ',' | append: variant.id -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        
        <div 
          class="rdc-classic-gallery__main-image {% if media.id == featured_media.id %}active{% endif %}"
          data-media-id="{{ media.id }}"
          data-index="{{ forloop.index0 }}"
          data-image-src="{{ media.src | split: '/' | last }}"
          data-variant-ids="{{ variant_ids }}"
          data-attached-to-variant="{{ media.attached_to_variant? }}"
        >
          {{
            media
            | image_url: width: 1200
            | image_tag:
              loading: 'eager',
              sizes: '(min-width: 768px) 50vw, 100vw',
              widths: '600, 900, 1200, 1500',
              alt: media.alt | escape
          }}
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>

  {%- comment -%} Thumbnail navigation {%- endcomment -%}
  {%- if media_count > 1 -%}
    <div class="rdc-classic-gallery__thumbnails">
      {%- for media in product.media -%}
        {%- if media.media_type == 'image' -%}
          {%- comment -%} Get variant IDs associated with this image {%- endcomment -%}
          {%- assign variant_ids = '' -%}
          {%- for variant in product.variants -%}
            {%- if variant.featured_media.id == media.id -%}
              {%- if variant_ids == '' -%}
                {%- assign variant_ids = variant.id | append: '' -%}
              {%- else -%}
                {%- assign variant_ids = variant_ids | append: ',' | append: variant.id -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          
          <div 
            class="rdc-classic-gallery__thumbnail {% if media.id == featured_media.id %}active{% endif %}"
            data-media-id="{{ media.id }}"
            data-index="{{ forloop.index0 }}"
            data-image-src="{{ media.src | split: '/' | last }}"
            data-variant-ids="{{ variant_ids }}"
            data-attached-to-variant="{{ media.attached_to_variant? }}"
          >
            {{
              media
              | image_url: width: 200
              | image_tag:
                loading: 'lazy',
                alt: media.alt | escape
            }}
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
  {%- endif -%}
</div>

<script>
  (function() {
    function initClassicGallery() {
      const gallery = document.getElementById('RdcClassicGallery-{{ section.id }}');
      if (!gallery) return;

      const thumbnails = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__thumbnail'));
      const mainImages = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__main-image'));

      // Clean color name from label text
      function cleanColorName(text) {
        let cleaned = text
          .replace(/Variante épuisée ou indisponible/gi, '')
          .replace(/Épuisé/gi, '')
          .replace(/Indisponible/gi, '')
          .replace(/Out of stock/gi, '')
          .replace(/Unavailable/gi, '')
          .trim();

        const parts = cleaned.split(':');
        if (parts.length > 1) {
          cleaned = parts[1].trim();
        }

        cleaned = cleaned.replace(/\s+/g, ' ').trim();
        return cleaned;
      }

      // Get selected color name from variant picker
      function getSelectedColorName() {
        const variantRadios = document.querySelectorAll(
          'variant-radios input[type="radio"]:checked, .product-form__input input[type="radio"]:checked'
        );

        for (const radio of variantRadios) {
          const label = document.querySelector(`label[for="${radio.id}"]`);
          const labelText = label?.textContent.trim() || '';
          const fieldset = radio.closest('fieldset');
          
          if (fieldset) {
            const legend = fieldset.querySelector('legend');
            const legendText = legend?.textContent.toLowerCase() || '';

            if (legendText.includes('couleur') || legendText.includes('color')) {
              const colorName = cleanColorName(labelText);
              return colorName;
            }
          }
        }

        const allColorInputs = document.querySelectorAll(
          'input[type="radio"][name*="Color"], input[type="radio"][name*="Couleur"], input[type="radio"][name*="color"], input[type="radio"][name*="couleur"]'
        );

        for (const input of allColorInputs) {
          if (input.checked) {
            const label = document.querySelector(`label[for="${input.id}"]`);
            const labelText = label?.textContent.trim() || input.value;
            const colorName = cleanColorName(labelText);
            return colorName;
          }
        }

        return '';
      }

      // Get selected variant ID
      function getSelectedVariantId() {
        const variantIdInput = document.querySelector('input[name="id"]');
        return variantIdInput ? variantIdInput.value : null;
      }

      // Filter images by color and variant
      function applyColorFilter() {
        const colorName = getSelectedColorName().toLowerCase();
        const selectedVariantId = getSelectedVariantId();

        if (!colorName) {
          // No color selected, hide all
          thumbnails.forEach(thumb => thumb.classList.add('hidden-by-filter'));
          mainImages.forEach(img => img.classList.add('hidden-by-filter'));
          return;
        }

        let variantImageIndex = -1;
        const visibleIndices = [];

        // Filter images
        thumbnails.forEach((thumb, index) => {
          const imageSrc = (thumb.dataset.imageSrc || '').toLowerCase();
          const variantIds = thumb.dataset.variantIds || '';
          const matchesColor = imageSrc.includes(colorName);
          const matchesVariant = selectedVariantId && variantIds.split(',').includes(String(selectedVariantId));

          if (matchesColor || matchesVariant) {
            thumb.classList.remove('hidden-by-filter');
            mainImages[index].classList.remove('hidden-by-filter');
            visibleIndices.push(index);

            if (matchesVariant && variantImageIndex === -1) {
              variantImageIndex = index;
            }
          } else {
            thumb.classList.add('hidden-by-filter');
            mainImages[index].classList.add('hidden-by-filter');
          }
        });

        // Set active image
        if (variantImageIndex !== -1) {
          setActiveImage(variantImageIndex);
        } else if (visibleIndices.length > 0) {
          setActiveImage(visibleIndices[0]);
        }
      }

      function setActiveImage(index) {
        thumbnails.forEach((thumb, i) => {
          thumb.classList.toggle('active', i === index);
        });

        mainImages.forEach((img, i) => {
          img.classList.toggle('active', i === index);
        });
      }

      // Click on visible thumbnails only
      thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', function(e) {
          e.preventDefault();
          if (!thumbnail.classList.contains('hidden-by-filter')) {
            setActiveImage(index);
          }
        });
      });

      // Listen for variant changes
      document.addEventListener('change', function(event) {
        if (event.target.matches('input[type="radio"]')) {
          setTimeout(applyColorFilter, 100);
        }
      });

      // Initial filter
      setTimeout(applyColorFilter, 200);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initClassicGallery);
    } else {
      initClassicGallery();
    }
  })();
</script>
