{%- comment -%}
  RDC Classic Product Gallery
  
  Clean, classic product gallery with main image on top and thumbnail navigation below.
  Similar to the reference design provided.
{%- endcomment -%}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<style>
  .rdc-classic-gallery {
    width: 100%;
  }

  .rdc-classic-gallery__grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .rdc-classic-gallery__item {
    background-color: #EEEDE6;
    border-radius: 8px;
    overflow: hidden;
    transition: opacity 0.3s ease;
    border: 2px solid transparent;
  }

  /* Layout: 1 large image + 2x2 grid */
  .rdc-classic-gallery__item--main {
    width: 100%;
    height: auto;
    margin-bottom: 1rem;
  }

  .rdc-classic-gallery__item--main img {
    height: auto;
    object-fit: contain;
  }

  .rdc-classic-gallery__item--half {
    width: calc(50% - 0.5rem);
    height: 300px;
  }

  .rdc-classic-gallery__item.hidden-by-filter {
    display: none;
  }

  .rdc-classic-gallery__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media (max-width: 767px) {
    .rdc-classic-gallery__grid {
      gap: 0.5rem;
    }

    .rdc-classic-gallery__item:first-child {
      height: auto;
    }

    /* Mobile: all items 50%-50% except first */
    .rdc-classic-gallery__item:not(:first-child) {
      width: calc(50% - 0.25rem);
      height: 150px;
    }
  }

  @media (max-width: 480px) {
    .rdc-classic-gallery__item:first-child {
      height: auto;
    }

    .rdc-classic-gallery__item:not(:first-child) {
      height: 120px;
    }
  }
</style>

<div class="rdc-classic-gallery" id="RdcClassicGallery-{{ section.id }}">
  <div class="rdc-classic-gallery__grid">
    {%- comment -%} Render all images - JavaScript will filter and reorder based on selected color {%- endcomment -%}
    {%- for media in product.media -%}
      {%- if media.media_type == 'image' -%}
        {%- comment -%} Get variant IDs associated with this image {%- endcomment -%}
        {%- assign variant_ids = '' -%}
        {%- assign is_featured = false -%}
        {%- for variant in product.variants -%}
          {%- if variant.featured_media.id == media.id -%}
            {%- assign is_featured = true -%}
            {%- if variant_ids == '' -%}
              {%- assign variant_ids = variant.id | append: '' -%}
            {%- else -%}
              {%- assign variant_ids = variant_ids | append: ',' | append: variant.id -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        
        <div 
          class="rdc-classic-gallery__item"
          data-media-id="{{ media.id }}"
          data-index="{{ forloop.index0 }}"
          data-image-src="{{ media.src | split: '/' | last }}"
          data-variant-ids="{{ variant_ids }}"
          data-is-featured="{{ is_featured }}"
          data-attached-to-variant="{{ media.attached_to_variant? }}"
          style="display: none;"
        >
          {{
            media
            | image_url: width: 1200
            | image_tag:
              loading: 'eager',
              sizes: '(min-width: 768px) 50vw, 100vw',
              widths: '600, 900, 1200, 1500',
              alt: media.alt | escape
          }}
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>

<script>
  (function() {
    function initClassicGallery() {
      const gallery = document.getElementById('RdcClassicGallery-{{ section.id }}');
      if (!gallery) return;

      const items = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__item'));

      // Clean color name from label text
      function cleanColorName(text) {
        let cleaned = text
          .replace(/Variante épuisée ou indisponible/gi, '')
          .replace(/Épuisé/gi, '')
          .replace(/Indisponible/gi, '')
          .replace(/Out of stock/gi, '')
          .replace(/Unavailable/gi, '')
          .trim();

        const parts = cleaned.split(':');
        if (parts.length > 1) {
          cleaned = parts[1].trim();
        }

        cleaned = cleaned.replace(/\s+/g, ' ').trim();
        return cleaned;
      }

      // Get selected color name from variant picker
      function getSelectedColorName() {
        const variantRadios = document.querySelectorAll(
          'variant-radios input[type="radio"]:checked, .product-form__input input[type="radio"]:checked'
        );

        for (const radio of variantRadios) {
          const label = document.querySelector(`label[for="${radio.id}"]`);
          const labelText = label?.textContent.trim() || '';
          const fieldset = radio.closest('fieldset');
          
          if (fieldset) {
            const legend = fieldset.querySelector('legend');
            const legendText = legend?.textContent.toLowerCase() || '';

            if (legendText.includes('couleur') || legendText.includes('color')) {
              const colorName = cleanColorName(labelText);
              return colorName;
            }
          }
        }

        const allColorInputs = document.querySelectorAll(
          'input[type="radio"][name*="Color"], input[type="radio"][name*="Couleur"], input[type="radio"][name*="color"], input[type="radio"][name*="couleur"]'
        );

        for (const input of allColorInputs) {
          if (input.checked) {
            const label = document.querySelector(`label[for="${input.id}"]`);
            const labelText = label?.textContent.trim() || input.value;
            const colorName = cleanColorName(labelText);
            return colorName;
          }
        }

        return '';
      }

      // Get selected variant ID
      function getSelectedVariantId() {
        const variantIdInput = document.querySelector('input[name="id"]');
        return variantIdInput ? variantIdInput.value : null;
      }

      // Filter and reorder images based on color
      function applyColorFilter() {
        const colorName = getSelectedColorName().toLowerCase();
        const selectedVariantId = getSelectedVariantId();

        // Hide all items first
        items.forEach(item => {
          item.style.display = 'none';
          item.classList.remove('rdc-classic-gallery__item--main', 'rdc-classic-gallery__item--half');
        });

        if (!colorName) {
          // No color selected - show first 5 images
          items.slice(0, 5).forEach((item, index) => {
            item.style.display = '';
            if (index === 0) {
              item.classList.add('rdc-classic-gallery__item--main');
            } else {
              item.classList.add('rdc-classic-gallery__item--half');
            }
          });
          return;
        }

        // Separate images into color-matched and featured media
        const colorMatched = [];
        const featuredMedia = [];
        
        items.forEach((item) => {
          const imageSrc = (item.dataset.imageSrc || '').toLowerCase();
          const isFeatured = item.dataset.isFeatured === 'true';
          const variantIds = item.dataset.variantIds || '';
          const matchesVariant = selectedVariantId && variantIds.split(',').includes(String(selectedVariantId));
          
          if (imageSrc.includes(colorName)) {
            colorMatched.push(item);
          } else if (isFeatured && matchesVariant) {
            featuredMedia.push(item);
          }
        });

        // Combine: color-matched first, then featured media, limit to 5
        const displayItems = [...colorMatched, ...featuredMedia].slice(0, 5);
        
        // Display and apply layout classes
        displayItems.forEach((item, index) => {
          item.style.display = '';
          if (index === 0) {
            item.classList.add('rdc-classic-gallery__item--main');
          } else {
            item.classList.add('rdc-classic-gallery__item--half');
          }
        });
      }

      // Listen for variant changes
      document.addEventListener('change', function(event) {
        if (event.target.matches('input[type="radio"]')) {
          setTimeout(applyColorFilter, 100);
        }
      });

      // Initial display
      setTimeout(applyColorFilter, 200);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initClassicGallery);
    } else {
      initClassicGallery();
    }
  })();
</script>
