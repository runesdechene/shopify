{%- comment -%}
  RDC Classic Product Gallery
  
  Clean, classic product gallery with main image on top and thumbnail navigation below.
  Similar to the reference design provided.
{%- endcomment -%}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<style>
  .rdc-classic-gallery {
    width: 100%;
  }

  .rdc-classic-gallery__grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .rdc-classic-gallery__item {
    background-color: #EEEDE6;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid transparent;
    cursor: pointer;
    pointer-events: auto;
    position: relative;
  }

  .rdc-classic-gallery__item img {
    pointer-events: none;
  }

  .rdc-classic-gallery__item:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .rdc-classic-gallery__item--main:hover {
    transform: none;
  }

  /* Layout: 1 large image + 2x2 grid */
  .rdc-classic-gallery__item--main {
    width: 100%;
    height: auto;
    margin-bottom: 1rem;
  }

  .rdc-classic-gallery__item--main img {
    height: auto;
    object-fit: contain;
  }

  .rdc-classic-gallery__item--half {
    flex: 0 0 calc(50% - 0.5rem);
    width: calc(50% - 0.5rem);
    max-width: calc(50% - 0.5rem);
    height: 300px;
  }

  .rdc-classic-gallery__item--large {
    flex: 0 0 calc(60% - 0.5rem);
    width: calc(60% - 0.5rem);
    max-width: calc(60% - 0.5rem);
    height: 300px;
  }

  .rdc-classic-gallery__item--small {
    flex: 0 0 calc(40% - 0.5rem);
    width: calc(40% - 0.5rem);
    max-width: calc(40% - 0.5rem);
    height: 300px;
  }

  .rdc-classic-gallery__item.hidden-by-filter {
    display: none;
  }

  .rdc-classic-gallery__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media (max-width: 767px) {
    .rdc-classic-gallery__grid {
      gap: 0.5rem;
    }

    .rdc-classic-gallery__item:first-child {
      height: auto;
    }

    /* Mobile: all items 50%-50% except first */
    .rdc-classic-gallery__item:not(:first-child) {
      width: calc(50% - 0.25rem);
      height: 150px;
    }
  }

  @media (max-width: 480px) {
    .rdc-classic-gallery__item:first-child {
      height: auto;
    }

    .rdc-classic-gallery__item:not(:first-child) {
      height: 120px;
    }
  }
</style>

<div class="rdc-classic-gallery" id="RdcClassicGallery-{{ section.id }}">
  <div class="rdc-classic-gallery__grid">
    {%- comment -%} Render all images - JavaScript will filter and reorder based on selected color {%- endcomment -%}
    {%- for media in product.media -%}
      {%- if media.media_type == 'image' -%}
        {%- comment -%} Get variant IDs associated with this image {%- endcomment -%}
        {%- assign variant_ids = '' -%}
        {%- assign is_featured = false -%}
        {%- for variant in product.variants -%}
          {%- if variant.featured_media.id == media.id -%}
            {%- assign is_featured = true -%}
            {%- if variant_ids == '' -%}
              {%- assign variant_ids = variant.id | append: '' -%}
            {%- else -%}
              {%- assign variant_ids = variant_ids | append: ',' | append: variant.id -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        
        {%- comment -%} Determine layout class based on position {%- endcomment -%}
        {%- assign layout_class = '' -%}
        {%- if forloop.index0 == 0 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--main' -%}
        {%- elsif forloop.index0 == 1 or forloop.index0 == 2 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--half' -%}
        {%- elsif forloop.index0 == 3 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--large' -%}
        {%- elsif forloop.index0 == 4 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--small' -%}
        {%- elsif forloop.index0 == 5 or forloop.index0 == 6 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--half' -%}
        {%- elsif forloop.index0 == 7 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--large' -%}
        {%- elsif forloop.index0 == 8 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--small' -%}
        {%- else -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--half' -%}
        {%- endif -%}
        
        <div 
          class="rdc-classic-gallery__item {{ layout_class }}"
          data-media-id="{{ media.id }}"
          data-index="{{ forloop.index0 }}"
          data-image-src="{{ media.src | split: '/' | last }}"
          data-variant-ids="{{ variant_ids }}"
          data-is-featured="{{ is_featured }}"
          data-attached-to-variant="{{ media.attached_to_variant? }}"
        >
          {{
            media
            | image_url: width: 1200
            | image_tag:
              loading: 'eager',
              sizes: '(min-width: 768px) 50vw, 100vw',
              widths: '600, 900, 1200, 1500',
              alt: media.alt | escape
          }}
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>

<script>
  (function() {
    function initClassicGallery() {
      const gallery = document.getElementById('RdcClassicGallery-{{ section.id }}');
      if (!gallery) return;

      const items = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__item'));
      
      // Apply layout classes to visible items
      function applyLayoutClasses() {
        const visibleItems = items.filter(item => item.style.display !== 'none');
        
        visibleItems.forEach((item, index) => {
          // Remove all layout classes first
          item.classList.remove('rdc-classic-gallery__item--main', 'rdc-classic-gallery__item--half', 'rdc-classic-gallery__item--large', 'rdc-classic-gallery__item--small');
          
          // Apply new layout class based on position
          if (index === 0) {
            item.classList.add('rdc-classic-gallery__item--main');
          } else if (index === 1 || index === 2) {
            item.classList.add('rdc-classic-gallery__item--half');
          } else if (index === 3) {
            item.classList.add('rdc-classic-gallery__item--large');
          } else if (index === 4) {
            item.classList.add('rdc-classic-gallery__item--small');
          } else if (index === 5 || index === 6) {
            item.classList.add('rdc-classic-gallery__item--half');
          } else if (index === 7) {
            item.classList.add('rdc-classic-gallery__item--large');
          } else if (index === 8) {
            item.classList.add('rdc-classic-gallery__item--small');
          } else {
            item.classList.add('rdc-classic-gallery__item--half');
          }
        });
      }

      // Get selected color name
      function getSelectedColorName() {
        const variantRadios = document.querySelectorAll('variant-radios input[type="radio"]:checked, .product-form__input input[type="radio"]:checked');
        
        for (const radio of variantRadios) {
          const fieldset = radio.closest('fieldset');
          if (fieldset) {
            const legend = fieldset.querySelector('legend');
            const legendText = legend?.textContent.toLowerCase() || '';
            
            if (legendText.includes('couleur') || legendText.includes('color')) {
              const label = document.querySelector(`label[for="${radio.id}"]`);
              let colorName = label?.textContent.trim() || '';
              colorName = colorName.replace(/Variante épuisée ou indisponible/gi, '').replace(/Épuisé/gi, '').trim();
              const parts = colorName.split(':');
              return parts.length > 1 ? parts[1].trim() : colorName;
            }
          }
        }
        return '';
      }

      // Filter images by color
      function filterByColor() {
        const colorName = getSelectedColorName().toLowerCase();
        
        if (!colorName) {
          // No color filter - show all
          items.forEach(item => item.style.display = '');
        } else {
          // Filter by color name in filename
          items.forEach(item => {
            const imageSrc = (item.dataset.imageSrc || '').toLowerCase();
            item.style.display = imageSrc.includes(colorName) ? '' : 'none';
          });
        }
        
        // Reapply layout classes after filtering
        applyLayoutClasses();
      }

      // Click to reorder
      items.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const clickedItem = e.currentTarget;
          
          if (clickedItem.style.display === 'none') return;
          if (clickedItem.classList.contains('rdc-classic-gallery__item--main')) return;
          
          // Move clicked item to first position in DOM
          const gridContainer = gallery.querySelector('.rdc-classic-gallery__grid');
          gridContainer.insertBefore(clickedItem, gridContainer.firstChild);
          
          // Update items array to reflect new DOM order
          const updatedItems = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__item'));
          
          // Reapply layout classes based on new DOM order
          const visibleItems = updatedItems.filter(item => item.style.display !== 'none');
          
          visibleItems.forEach((item, index) => {
            item.classList.remove('rdc-classic-gallery__item--main', 'rdc-classic-gallery__item--half', 'rdc-classic-gallery__item--large', 'rdc-classic-gallery__item--small');
            
            if (index === 0) {
              item.classList.add('rdc-classic-gallery__item--main');
            } else if (index === 1 || index === 2) {
              item.classList.add('rdc-classic-gallery__item--half');
            } else if (index === 3) {
              item.classList.add('rdc-classic-gallery__item--large');
            } else if (index === 4) {
              item.classList.add('rdc-classic-gallery__item--small');
            } else if (index === 5 || index === 6) {
              item.classList.add('rdc-classic-gallery__item--half');
            } else if (index === 7) {
              item.classList.add('rdc-classic-gallery__item--large');
            } else if (index === 8) {
              item.classList.add('rdc-classic-gallery__item--small');
            } else {
              item.classList.add('rdc-classic-gallery__item--half');
            }
          });
        });
      });

      // Listen for variant changes
      document.addEventListener('change', function(event) {
        if (event.target.matches('input[type="radio"]')) {
          setTimeout(filterByColor, 50);
        }
      });

      // Initial setup
      applyLayoutClasses();
      setTimeout(filterByColor, 100);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initClassicGallery);
    } else {
      initClassicGallery();
    }
  })();
</script>
