{%- comment -%}
  RDC Classic Product Gallery
  
  Clean, classic product gallery with main image on top and thumbnail navigation below.
  Similar to the reference design provided.
{%- endcomment -%}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<style>
  .rdc-classic-gallery {
    width: 100%;
  }

  .rdc-classic-gallery__grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .rdc-classic-gallery__item {
    background-color: #EEEDE6;
    border-radius: 8px;
    overflow: visible;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid transparent;
    cursor: pointer;
    pointer-events: auto;
    position: relative;
  }

  .rdc-classic-gallery__item img {
    pointer-events: none;
  }

  .rdc-classic-gallery__item:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .rdc-classic-gallery__item--main:hover {
    transform: none;
  }

  /* Layout: 1 large image + 2x2 grid */
  .rdc-classic-gallery__item--main {
    width: 100%;
    height: auto;
    margin-bottom: 3rem;
    position: relative;
  }

  .rdc-classic-gallery__item--main img {
    height: auto;
    object-fit: contain;
  }
  
  .rdc-classic-gallery__zoom-button {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    background: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.2s;
    z-index: 10;
  }
  
  .rdc-classic-gallery__zoom-button:hover {
    transform: scale(1.1);
  }
  
  .rdc-classic-gallery__zoom-button svg {
    width: 20px;
    height: 20px;
  }
  
  .rdc-gallery-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgb(245,245,245);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }
  
  .rdc-gallery-modal.active {
    display: flex;
  }
  
  .rdc-gallery-modal__content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
  }
  
  .rdc-gallery-modal__image {
    max-width: 100%;
    max-height: 85vh;
    margin-top: -5vh;
    border-radius: 5px;
    object-fit: contain;
  }
  
  .rdc-gallery-modal__caption {
    text-align: center;
    color: #333;
    font-size: 16px;
    margin-top: 1.5rem;
    padding: 0 2rem;
    line-height: 1.5;
  }
  
  .rdc-gallery-modal__close {
    position: absolute;
    bottom: 4rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgb(255, 255, 255);
    border: 2px solid #EEEDE6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    cursor: pointer;
    font-size: 34px;
    line-height: 1;
  }

  .rdc-classic-gallery__item--half {
    flex: 0 0 calc(50% - 0.5rem);
    width: calc(50% - 0.5rem);
    max-width: calc(50% - 0.5rem);
    height: 300px;
  }

  .rdc-classic-gallery__item--large {
    flex: 0 0 calc(60% - 0.5rem);
    width: calc(60% - 0.5rem);
    max-width: calc(60% - 0.5rem);
    height: 300px;
  }

  .rdc-classic-gallery__item--small {
    flex: 0 0 calc(40% - 0.5rem);
    width: calc(40% - 0.5rem);
    max-width: calc(40% - 0.5rem);
    height: 300px;
  }
  
  .rdc-classic-gallery__item--single {
    width: 100%;
    height: auto;
    max-height: 500px;
  }
  
  .rdc-classic-gallery__item--single img {
    height: auto;
    max-height: 500px;
    object-fit: contain;
  }

  .rdc-classic-gallery__item.hidden-by-filter {
    display: none;
  }
  
  .rdc-classic-gallery__caption {
    position: absolute;
    bottom: -3.4rem;
    left: 0;
    right: 0;
    text-align: left;
    color: #635d5d;
    font-size: 16px;
    line-height: 1.5;
    font-family: var(--font-accent-family);
  }

  .rdc-classic-gallery__item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 8px;
  }

  @media (max-width: 767px) {
    .rdc-classic-gallery__grid {
      gap: 0.5rem;
    }

    .rdc-classic-gallery__item:first-child {
      height: auto;
    }

    /* Mobile: all items 50%-50% except first */
    .rdc-classic-gallery__item:not(:first-child) {
      width: calc(50% - 0.25rem);
      height: 150px;
    }
  }

  @media (max-width: 480px) {
    .rdc-classic-gallery__item:first-child {
      height: auto;
    }

    .rdc-classic-gallery__item:not(:first-child) {
      height: 120px;
    }
  }
</style>

{{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}

<div class="rdc-classic-gallery" id="RdcClassicGallery-{{ section.id }}">
  <div class="rdc-classic-gallery__grid">
    {%- comment -%} Render all images - JavaScript will filter and reorder based on selected color {%- endcomment -%}
    {%- for media in product.media -%}
      {%- if media.media_type == 'image' -%}
        {%- comment -%} Get variant IDs associated with this image {%- endcomment -%}
        {%- assign variant_ids = '' -%}
        {%- assign is_featured = false -%}
        {%- for variant in product.variants -%}
          {%- if variant.featured_media.id == media.id -%}
            {%- assign is_featured = true -%}
            {%- if variant_ids == '' -%}
              {%- assign variant_ids = variant.id | append: '' -%}
            {%- else -%}
              {%- assign variant_ids = variant_ids | append: ',' | append: variant.id -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        
        {%- comment -%} Determine layout class based on position {%- endcomment -%}
        {%- assign layout_class = '' -%}
        {%- if forloop.index0 == 0 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--main' -%}
        {%- elsif forloop.index0 == 1 or forloop.index0 == 2 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--half' -%}
        {%- elsif forloop.index0 == 3 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--large' -%}
        {%- elsif forloop.index0 == 4 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--small' -%}
        {%- elsif forloop.index0 == 5 or forloop.index0 == 6 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--half' -%}
        {%- elsif forloop.index0 == 7 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--large' -%}
        {%- elsif forloop.index0 == 8 -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--small' -%}
        {%- else -%}
          {%- assign layout_class = 'rdc-classic-gallery__item--half' -%}
        {%- endif -%}
        
        <div 
          class="rdc-classic-gallery__item {{ layout_class }}"
          data-media-id="{{ media.id }}"
          data-index="{{ forloop.index0 }}"
          data-image-src="{{ media.src | split: '/' | last }}"
          data-variant-ids="{{ variant_ids }}"
          data-is-featured="{{ is_featured }}"
          data-attached-to-variant="{{ media.attached_to_variant? }}"
          data-resume="{%- if product.type != blank -%}{%- assign product_type_lower = product.type | downcase | strip -%}{%- for produit in shop.metaobjects.produits.values -%}{%- assign produit_nom = produit.nom.value | downcase | strip -%}{%- if produit_nom == product_type_lower -%}Modèle<b> « {{ produit.nom.value }} »</b>{% if produit.type != blank %} {{ produit.type.value | downcase }}{% endif %}{% if produit.coupe != blank %} {{ produit.coupe.value | downcase }}{% endif %}{% if produit.tissu != blank %} {{ produit.tissu.value | join: ', ' | downcase }}{% endif %}{%- break -%}{%- endif -%}{%- endfor -%}{%- endif -%}"
          data-product-title="{{ product.title | escape }}"
        >
          {{
            media
            | image_url: width: 1200
            | image_tag:
              loading: 'eager',
              sizes: '(min-width: 768px) 50vw, 100vw',
              widths: '600, 900, 1200, 1500',
              alt: media.alt | escape
          }}
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>

<!-- Zoom Modal -->
<div class="rdc-gallery-modal" id="RdcGalleryModal-{{ section.id }}">
  <button class="rdc-gallery-modal__close" id="RdcModalClose-{{ section.id }}">&times;</button>
  <div class="rdc-gallery-modal__content">
    <img class="rdc-gallery-modal__image" id="RdcModalImage-{{ section.id }}" src="" alt="">
    <p class="rdc-gallery-modal__caption" id="RdcModalCaption-{{ section.id }}"></p>
  </div>
</div>

<script>
  (function() {
    function initClassicGallery() {
      const gallery = document.getElementById('RdcClassicGallery-{{ section.id }}');
      if (!gallery) return;

      const items = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__item'));
      const modal = document.getElementById('RdcGalleryModal-{{ section.id }}');
      const modalImage = document.getElementById('RdcModalImage-{{ section.id }}');
      const modalCaption = document.getElementById('RdcModalCaption-{{ section.id }}');
      const modalClose = document.getElementById('RdcModalClose-{{ section.id }}');
      
      // Update gallery caption with product type of visible main image
      function updateGalleryCaption() {
        // Remove all existing captions
        const existingCaptions = gallery.querySelectorAll('.rdc-classic-gallery__caption');
        existingCaptions.forEach(cap => cap.remove());
        
        // Find visible main image
        const mainItems = gallery.querySelectorAll('.rdc-classic-gallery__item--main');
        let visibleMainItem = null;
        
        for (const item of mainItems) {
          if (item.style.display !== 'none') {
            visibleMainItem = item;
            break;
          }
        }
        
        // Create and append caption to visible main item
        if (visibleMainItem) {
          const img = visibleMainItem.querySelector('img');
          const altText = img ? (img.alt || '').trim() : '';
          const resume = visibleMainItem.dataset.resume || '';
          const productTitle = visibleMainItem.dataset.productTitle || '';
          
          // If ALT is empty or equals product title (Shopify default), use resume from metaobject
          // Otherwise use the custom ALT text
          let captionText = resume;
          if (altText && altText !== productTitle) {
            captionText = altText;
          }
          
          const caption = document.createElement('p');
          caption.className = 'rdc-classic-gallery__caption';
          caption.innerHTML = captionText;
          visibleMainItem.appendChild(caption);
        }
      }
      
      // Add zoom button to main image
      function addZoomButton() {
        // Remove ALL existing zoom buttons from entire gallery
        const allZoomButtons = gallery.querySelectorAll('.rdc-classic-gallery__zoom-button');
        allZoomButtons.forEach(btn => btn.remove());
        
        // Find the VISIBLE main image (not display:none)
        const mainItems = gallery.querySelectorAll('.rdc-classic-gallery__item--main');
        let visibleMainItem = null;
        
        for (const item of mainItems) {
          if (item.style.display !== 'none') {
            visibleMainItem = item;
            break;
          }
        }
        
        if (!visibleMainItem) return;
        
        // Create zoom button
        const zoomButton = document.createElement('button');
        zoomButton.className = 'rdc-classic-gallery__zoom-button';
        zoomButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" /></svg>';
        zoomButton.setAttribute('aria-label', 'Zoom image');
        
        zoomButton.addEventListener('click', function(e) {
          e.stopPropagation();
          const img = visibleMainItem.querySelector('img');
          if (img) {
            modalImage.src = img.src.replace(/_(small|compact|medium|large|grande|pico|icon|thumb|small|compact|medium|large|grande|1024x1024|2048x2048|master)\./, '_2048x2048.');
            modalImage.alt = img.alt;
            
            // Set caption: use resume from metaobject if ALT is empty or equals product title
            const altText = (img.alt || '').trim();
            const resume = visibleMainItem.dataset.resume || '';
            const productTitle = visibleMainItem.dataset.productTitle || '';
            
            let captionText = resume;
            if (altText && altText !== productTitle) {
              captionText = altText;
            }
            
            modalCaption.innerHTML = captionText;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
          }
        });
        
        visibleMainItem.appendChild(zoomButton);
      }
      
      // Close modal
      function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      modalClose.addEventListener('click', closeModal);
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeModal();
        }
      });
      
      // Apply layout classes to visible items
      function applyLayoutClasses() {
        const visibleItems = items.filter(item => item.style.display !== 'none');
        
        visibleItems.forEach((item, index) => {
          // Remove all layout classes first
          item.classList.remove('rdc-classic-gallery__item--main', 'rdc-classic-gallery__item--half', 'rdc-classic-gallery__item--large', 'rdc-classic-gallery__item--small', 'rdc-classic-gallery__item--single');
          
          // Apply new layout class based on position
          if (index === 0) {
            item.classList.add('rdc-classic-gallery__item--main');
            item.style.height = 'auto'; // Always reset main image height
          } else if (index === 1 || index === 2) {
            item.classList.add('rdc-classic-gallery__item--half');
          } else if (index === 3) {
            item.classList.add('rdc-classic-gallery__item--large');
          } else if (index === 4) {
            item.classList.add('rdc-classic-gallery__item--small');
          } else if (index === 5 || index === 6) {
            item.classList.add('rdc-classic-gallery__item--half');
          } else if (index === 7) {
            item.classList.add('rdc-classic-gallery__item--large');
          } else if (index === 8) {
            item.classList.add('rdc-classic-gallery__item--small');
          } else {
            item.classList.add('rdc-classic-gallery__item--half');
          }
        });
        
        // Check if last item is alone on its row (odd number of items after main)
        if (visibleItems.length > 1 && (visibleItems.length - 1) % 2 === 1) {
          const lastItem = visibleItems[visibleItems.length - 1];
          lastItem.classList.remove('rdc-classic-gallery__item--half', 'rdc-classic-gallery__item--large', 'rdc-classic-gallery__item--small');
          lastItem.classList.add('rdc-classic-gallery__item--single');
        }
        
        // After applying classes, equalize row heights, add zoom button, and update caption
        setTimeout(equalizeRowHeights, 100);
        setTimeout(addZoomButton, 150);
        setTimeout(updateGalleryCaption, 150);
      }
      
      // Equalize row heights based on shortest image (with items parameter)
      function equalizeRowHeightsWithItems(itemsArray) {
        const visibleItems = itemsArray.filter(item => item.style.display !== 'none' && !item.classList.contains('rdc-classic-gallery__item--main'));
        
        // Group items into rows (pairs)
        const rows = [];
        for (let i = 0; i < visibleItems.length; i += 2) {
          const row = [visibleItems[i]];
          if (visibleItems[i + 1]) {
            row.push(visibleItems[i + 1]);
          }
          rows.push(row);
        }
        
        // For each row, find shortest natural height
        rows.forEach(row => {
          // Reset heights first
          row.forEach(item => item.style.height = 'auto');
          
          setTimeout(() => {
            const heights = row.map(item => {
              const img = item.querySelector('img');
              if (!img || !img.complete) return Infinity;
              
              const containerWidth = item.offsetWidth;
              const naturalRatio = img.naturalHeight / img.naturalWidth;
              return containerWidth * naturalRatio;
            });
            
            const minHeight = Math.min(...heights);
            
            if (minHeight > 0 && minHeight !== Infinity) {
              row.forEach(item => {
                item.style.height = minHeight + 'px';
              });
            }
          }, 50);
        });
      }
      
      // Equalize row heights (uses global items array)
      function equalizeRowHeights() {
        equalizeRowHeightsWithItems(items);
      }

      // Get selected color name
      function getSelectedColorName() {
        const variantRadios = document.querySelectorAll('variant-radios input[type="radio"]:checked, .product-form__input input[type="radio"]:checked');
        
        for (const radio of variantRadios) {
          const fieldset = radio.closest('fieldset');
          
          if (fieldset) {
            // Check if fieldset has color class OR legend contains color/couleur
            const hasColorClass = fieldset.classList.contains('product-form__input--color');
            const legend = fieldset.querySelector('legend');
            const legendText = legend?.textContent.toLowerCase() || '';
            const hasColorLegend = legendText.includes('couleur') || legendText.includes('color');
            
            if (hasColorClass || hasColorLegend) {
              const label = document.querySelector(`label[for="${radio.id}"]`);
              let colorName = label?.textContent.trim() || '';
              colorName = colorName.replace(/Variante épuisée ou indisponible/gi, '').replace(/Épuisé/gi, '').trim();
              const parts = colorName.split(':');
              return parts.length > 1 ? parts[1].trim() : colorName;
            }
          }
        }
        
        return '';
      }

      // Get selected variant ID
      function getSelectedVariantId() {
        const variantIdInput = document.querySelector('input[name="id"]');
        return variantIdInput ? variantIdInput.value : null;
      }

      // Reset images to original DOM order
      function resetImageOrder() {
        const gridContainer = gallery.querySelector('.rdc-classic-gallery__grid');
        
        // Sort items by their original data-index attribute
        const sortedItems = [...items].sort((a, b) => {
          const indexA = parseInt(a.dataset.index) || 0;
          const indexB = parseInt(b.dataset.index) || 0;
          return indexA - indexB;
        });
        
        // Reappend in original order
        sortedItems.forEach(item => {
          gridContainer.appendChild(item);
        });
      }

      // Filter images by color
      function filterByColor() {
        const colorName = getSelectedColorName().toLowerCase();
        const selectedVariantId = getSelectedVariantId();
        
        // Reset images to original order when variant changes
        resetImageOrder();
        
        if (!colorName) {
          // No color filter - show all
          items.forEach(item => item.style.display = '');
        } else {
          // Filter by color name in filename OR featured image for active variant OR 'total' in filename
          items.forEach(item => {
            const imageSrc = (item.dataset.imageSrc || '').toLowerCase();
            const isFeatured = item.dataset.isFeatured === 'true';
            const variantIds = item.dataset.variantIds || '';
            const matchesVariant = selectedVariantId && variantIds.split(',').includes(String(selectedVariantId));
            
            const hasColorInName = imageSrc.includes(colorName);
            const isFeaturedForVariant = isFeatured && matchesVariant;
            const hasTotal = imageSrc.includes('total');
            
            // Show if: color name in filename OR (is featured AND matches current variant) OR has 'total'
            item.style.display = (hasColorInName || isFeaturedForVariant || hasTotal) ? '' : 'none';
          });
        }
        
        // Reapply layout classes after filtering
        applyLayoutClasses();
      }

      // Click to reorder
      items.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const clickedItem = e.currentTarget;
          
          if (clickedItem.style.display === 'none') return;
          if (clickedItem.classList.contains('rdc-classic-gallery__item--main')) return;
          
          // Get all visible items before reordering
          const visibleItemsBefore = items.filter(item => item.style.display !== 'none');
          
          // Add fade out animation
          visibleItemsBefore.forEach(item => {
            item.style.opacity = '0.5';
            item.style.transform = 'scale(0.98)';
          });
          
          setTimeout(() => {
            // Move clicked item to first position in DOM
            const gridContainer = gallery.querySelector('.rdc-classic-gallery__grid');
            gridContainer.insertBefore(clickedItem, gridContainer.firstChild);
            
            // Update items array to reflect new DOM order
            const updatedItems = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__item'));
            
            // Reapply layout classes based on new DOM order
            const visibleItems = updatedItems.filter(item => item.style.display !== 'none');
            
            visibleItems.forEach((item, index) => {
              item.classList.remove('rdc-classic-gallery__item--main', 'rdc-classic-gallery__item--half', 'rdc-classic-gallery__item--large', 'rdc-classic-gallery__item--small', 'rdc-classic-gallery__item--single');
              
              if (index === 0) {
                item.classList.add('rdc-classic-gallery__item--main');
                item.style.height = 'auto'; // Reset height for main image
              } else if (index === 1 || index === 2) {
                item.classList.add('rdc-classic-gallery__item--half');
              } else if (index === 3) {
                item.classList.add('rdc-classic-gallery__item--large');
              } else if (index === 4) {
                item.classList.add('rdc-classic-gallery__item--small');
              } else if (index === 5 || index === 6) {
                item.classList.add('rdc-classic-gallery__item--half');
              } else if (index === 7) {
                item.classList.add('rdc-classic-gallery__item--large');
              } else if (index === 8) {
                item.classList.add('rdc-classic-gallery__item--small');
              } else {
                item.classList.add('rdc-classic-gallery__item--half');
              }
            });
            
            // Check if last item is alone on its row (odd number of items after main)
            if (visibleItems.length > 1 && (visibleItems.length - 1) % 2 === 1) {
              const lastItem = visibleItems[visibleItems.length - 1];
              lastItem.classList.remove('rdc-classic-gallery__item--half', 'rdc-classic-gallery__item--large', 'rdc-classic-gallery__item--small');
              lastItem.classList.add('rdc-classic-gallery__item--single');
            }
            
            // Fade back in
            setTimeout(() => {
              visibleItems.forEach(item => {
                item.style.opacity = '1';
                item.style.transform = 'scale(1)';
              });
              
              // Recalculate row heights after reordering with updated items
              setTimeout(() => {
                const updatedItemsForHeight = Array.from(gallery.querySelectorAll('.rdc-classic-gallery__item'));
                equalizeRowHeightsWithItems(updatedItemsForHeight);
              }, 100);
              
              // Move zoom button to new main image and update caption
              setTimeout(addZoomButton, 150);
              setTimeout(updateGalleryCaption, 150);
            }, 50);
          }, 200);
        });
      });

      // Listen for variant changes
      document.addEventListener('change', function(event) {
        if (event.target.matches('input[type="radio"]')) {
          setTimeout(filterByColor, 50);
        }
      });

      // Initial setup
      applyLayoutClasses();
      setTimeout(filterByColor, 100);
      
      // Add zoom button after initial setup
      setTimeout(addZoomButton, 500);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initClassicGallery);
    } else {
      initClassicGallery();
    }
  })();
</script>
