{% comment %}
  RDC Custom Product Media Gallery
  Système personnalisé avec 4 miniatures verticales visibles
{% endcomment %}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media
-%}

<style>
  .rdc-gallery {
    display: flex;
    gap: 1.5rem;
    width: 100%;
    align-items: flex-start;
  }

  .rdc-gallery__thumbnails-wrapper {
    width: 150px;
    flex-shrink: 0;
    position: relative;
  }

  .rdc-gallery__thumbnails-container {
    overflow: hidden;
    position: relative;
  }

  .rdc-gallery__thumbnails {
    display: flex;
    flex-direction: column;
    gap: 0;
    transition: transform 0.3s ease;
    height: 100%;
  }

  .rdc-gallery__thumbnail {
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    flex-shrink: 0;
    background-color: #EEEDE6;
    opacity: 0.7;
    transition: all 0.3s ease-in-out;
  }

  .rdc-gallery__thumbnail.active {
    opacity: 1;
  }

  .rdc-gallery__thumbnail:hover {
    opacity: 1
  }

  .rdc-gallery__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .rdc-gallery__nav-button {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: background 0.2s ease;
  }

  .rdc-gallery__nav-button:hover {
    background: #fff;
  }

  .rdc-gallery__nav-button.disabled {
    opacity: 0.3;
    pointer-events: none;
  }

  .rdc-gallery__nav-button--up {
    top: -16px;
  }

  .rdc-gallery__nav-button--down {
    bottom: -16px;
  }

  .rdc-gallery__nav-button svg {
    width: 16px;
    height: 16px;
  }

  .rdc-gallery__main {
    flex: 1;
  }

  .rdc-gallery__main-image {
    width: 100%;
    display: none;
    background-color: #EEEDE6;
    border-radius: 8px;
  }

  .rdc-gallery__main-image.active {
    display: block;
  }

  .rdc-gallery__main-image img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    max-height: 80vh;
    object-fit: cover;;
  }

  .rdc-gallery__alt-text {
    margin-top: 1rem;
    font-size: 1.7rem;
    font-weight: bold;
    color: #afa8a8;
    text-align: left;
  }

  @media (max-width: 767px) {
    .rdc-gallery {
      flex-direction: column-reverse;
    }

    .rdc-gallery__thumbnails-wrapper {
      width: 100%;
    }

    .rdc-gallery__thumbnails-container {
      height: auto;
    }

    .rdc-gallery__thumbnails {
      flex-direction: row;
      overflow-x: auto;
    }

    .rdc-gallery__thumbnail {
      width: 80px;
      flex-shrink: 0;
    }

    .rdc-gallery__nav-button {
      display: none;
    }
  }
</style>


<div class="rdc-gallery{% if section.settings.enable_sticky_info %} product__column-sticky{% endif %}" id="RdcGallery-{{ section.id }}">
  <!-- Miniatures à gauche -->
  <div class="rdc-gallery__thumbnails-wrapper">
    {%- if media_count > 4 -%}
      <button class="rdc-gallery__nav-button rdc-gallery__nav-button--up disabled" type="button" aria-label="Précédent">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
      </button>
    {%- endif -%}

    <div class="rdc-gallery__thumbnails-container">
      <div class="rdc-gallery__thumbnails" id="RdcThumbnails-{{ section.id }}">
        {%- for media in product.media -%}
          {%- if media.media_type == 'image' -%}
            <div 
              class="rdc-gallery__thumbnail {% if media.id == featured_media.id %}active{% endif %}"
              data-media-id="{{ media.id }}"
              data-index="{{ forloop.index0 }}"
              data-aspect-ratio="{{ media.aspect_ratio }}"
            >
              {{
                media
                | image_url: width: 200
                | image_tag:
                  loading: 'lazy',
                  alt: media.alt | escape
              }}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>

    {%- if media_count > 4 -%}
      <button class="rdc-gallery__nav-button rdc-gallery__nav-button--down" type="button" aria-label="Suivant">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
    {%- endif -%}
  </div>
  <!-- Image principale à droite -->
  <div class="rdc-gallery__main">
    {%- for media in product.media -%}
      {%- if media.media_type == 'image' -%}
        <div 
          class="rdc-gallery__main-image {% if media.id == featured_media.id %}active{% endif %}"
          data-media-id="{{ media.id }}"
          data-index="{{ forloop.index0 }}"
          data-alt="{{ media.alt | escape }}"
        >
          {{
            media
            | image_url: width: 1200
            | image_tag:
              loading: 'eager',
              sizes: '(min-width: 768px) 60vw, 100vw',
              widths: '600, 900, 1200, 1500',
              alt: media.alt | escape
          }}
        </div>
      {%- endif -%}
    {%- endfor -%}
    <div class="rdc-gallery__alt-text" id="RdcAltText-{{ section.id }}">
      {{ featured_media.alt | escape }}
    </div>
  </div>
</div>

<script>
  (function() {
    function initGallery() {
      const gallery = document.getElementById('RdcGallery-{{ section.id }}');
      if (!gallery) {
        console.error('Gallery not found');
        return;
      }

      const thumbnails = Array.from(gallery.querySelectorAll('.rdc-gallery__thumbnail'));
      const mainImages = Array.from(gallery.querySelectorAll('.rdc-gallery__main-image'));
      const thumbnailsContainer = gallery.querySelector('.rdc-gallery__thumbnails');
      const navButtonUp = gallery.querySelector('.rdc-gallery__nav-button--up');
      const navButtonDown = gallery.querySelector('.rdc-gallery__nav-button--down');

      console.log('Gallery initialized:', {
        thumbnails: thumbnails.length,
        mainImages: mainImages.length
      });

      let currentIndex = 0;
      let scrollIndex = 0;
      const visibleCount = 4;

      function calculateThumbnailHeight() {
        const mainImage = gallery.querySelector('.rdc-gallery__main-image.active img');
        if (!mainImage) return;

        const mainImageHeight = mainImage.offsetHeight;
        const gap = 12;
        const totalGaps = gap * 3; // 3 gaps entre 4 miniatures
        
        // Calculer la hauteur du texte ALT (margin-top + hauteur du texte)
        const altText = gallery.querySelector('.rdc-gallery__alt-text');
        const altTextHeight = altText ? altText.offsetHeight + 16 : 0; // 16px = 1rem margin-top
        
        // Hauteur totale du conteneur = hauteur de l'image + hauteur du texte ALT
        const totalContainerHeight = mainImageHeight + altTextHeight;
        const availableHeight = totalContainerHeight - totalGaps;
        
        // Définir la hauteur du conteneur = hauteur de l'image principale + texte ALT
        const container = gallery.querySelector('.rdc-gallery__thumbnails-container');
        if (container) {
          container.style.height = `${totalContainerHeight}px`;
        }
        
        // Calculer la somme des ratios des 4 premières miniatures
        let totalRatio = 0;
        for (let i = 0; i < Math.min(4, thumbnails.length); i++) {
          const aspectRatio = parseFloat(thumbnails[i].dataset.aspectRatio) || 1;
          // Inverser le ratio car on veut la hauteur relative (plus le ratio est grand, plus l'image est large, donc moins haute)
          totalRatio += (1 / aspectRatio);
        }
        
        // Calculer et appliquer la hauteur de chaque miniature en fonction de son ratio
        thumbnails.forEach((thumb, index) => {
          const aspectRatio = parseFloat(thumb.dataset.aspectRatio) || 1;
          const heightRatio = (1 / aspectRatio) / totalRatio;
          const thumbnailHeight = availableHeight * heightRatio;
          
          thumb.style.height = `${thumbnailHeight}px`;
          thumb.style.flexGrow = heightRatio;
          // Ajouter margin-bottom sauf pour la dernière miniature
          thumb.style.marginBottom = index < thumbnails.length - 1 ? `${gap}px` : '0';
        });

        console.log('Main image height:', mainImageHeight, 'Alt text height:', altTextHeight, 'Total container height:', totalContainerHeight);
      }

      function updateThumbnailsPosition() {
        if (!thumbnailsContainer) return;
        
        const thumbnailHeight = thumbnails[0]?.offsetHeight || 0;
        const gap = 12;
        const offset = scrollIndex * (thumbnailHeight + gap);
        thumbnailsContainer.style.transform = `translateY(-${offset}px)`;

        if (navButtonUp) {
          navButtonUp.classList.toggle('disabled', scrollIndex === 0);
        }
        if (navButtonDown) {
          const maxScroll = Math.max(0, thumbnails.length - visibleCount);
          navButtonDown.classList.toggle('disabled', scrollIndex >= maxScroll);
        }
      }

      function setActiveImage(index) {
        console.log('Setting active image:', index);
        currentIndex = index;

        thumbnails.forEach((thumb, i) => {
          if (i === index) {
            thumb.classList.add('active');
          } else {
            thumb.classList.remove('active');
          }
        });

        mainImages.forEach((img, i) => {
          if (i === index) {
            img.classList.add('active');
          } else {
            img.classList.remove('active');
          }
        });

        // Mettre à jour le texte ALT
        const altText = gallery.querySelector('.rdc-gallery__alt-text');
        const activeImage = mainImages[index];
        if (altText && activeImage) {
          altText.textContent = activeImage.dataset.alt || '';
        }

        // Centrer la miniature cliquée en position 1 (deuxième position visible)
        const targetScrollIndex = Math.max(0, index - 1);
        const maxScroll = Math.max(0, thumbnails.length - visibleCount);
        scrollIndex = Math.min(targetScrollIndex, maxScroll);
        
        console.log('Scrolling to index:', scrollIndex);
        updateThumbnailsPosition();
      }

      thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', function(e) {
          console.log('Thumbnail clicked:', index);
          e.preventDefault();
          setActiveImage(index);
        });
      });

      if (navButtonUp) {
        navButtonUp.addEventListener('click', function(e) {
          e.preventDefault();
          if (scrollIndex > 0) {
            scrollIndex--;
            updateThumbnailsPosition();
          }
        });
      }

      if (navButtonDown) {
        navButtonDown.addEventListener('click', function(e) {
          e.preventDefault();
          const maxScroll = Math.max(0, thumbnails.length - visibleCount);
          if (scrollIndex < maxScroll) {
            scrollIndex++;
            updateThumbnailsPosition();
          }
        });
      }

      // Calculer la hauteur des miniatures au chargement
      setTimeout(() => {
        calculateThumbnailHeight();
        updateThumbnailsPosition();
      }, 100);

      // Recalculer au resize de la fenêtre
      window.addEventListener('resize', () => {
        calculateThumbnailHeight();
        updateThumbnailsPosition();
      });

      // Recalculer quand les images sont chargées
      mainImages.forEach(img => {
        const imgElement = img.querySelector('img');
        if (imgElement) {
          imgElement.addEventListener('load', () => {
            calculateThumbnailHeight();
          });
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGallery);
    } else {
      initGallery();
    }
  })();
</script>
