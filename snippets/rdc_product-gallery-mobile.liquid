{%- comment -%}
  RDC Mobile Product Gallery
  
  Mobile-optimized carousel gallery with vertical scroll and thumbnails.
  Maintains variant filtering and ALT caption features from desktop gallery.
{%- endcomment -%}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
-%}

<style>
  .rdc-mobile-gallery {
    position: relative;
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .rdc-mobile-gallery__main {
    position: relative;
    flex: 1;
    overflow: hidden;
    background: #EEEDE6;
    border-radius: 8px;
  }

   @media screen and (max-width: 767px) {
      .rdc-mobile-gallery__main {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
  }

  .rdc-mobile-gallery__main-image {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }

  .rdc-mobile-gallery__caption {
    text-align: left;
    color: #635d5d;
    font-size: 14px;
    line-height: 1.5;
    font-family: var(--font-accent-family);
    margin-top: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 0 0.5rem;
  }

   @media screen and (max-width: 767px) {
  .rdc-mobile-gallery__caption {
    margin-top: 5px;
    margin-bottom: 0;
    padding-left: 25px;
  }
   }

  .rdc-mobile-gallery__thumbnails {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    overflow-y: auto;
    max-height: 500px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    flex-shrink: 0;
  }

  .rdc-mobile-gallery__thumbnails::-webkit-scrollbar {
    display: none;
  }

  .rdc-mobile-gallery__thumb {
    flex: 0 0 80px;
    width: 80px;
    height: 80px;
    background: #EEEDE6;
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .rdc-mobile-gallery__thumb.active {
    border-color: #534f4f;
  }

  .rdc-mobile-gallery__thumb.hidden-by-filter {
    display: none;
  }

  .rdc-mobile-gallery__thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .rdc-mobile-gallery__counter {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.9);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: #534f4f;
    z-index: 10;
  }

  /* Zoom modal for mobile */
  .rdc-mobile-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgb(245,245,245);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }
  
  .rdc-mobile-modal.active {
    display: flex;
  }
  
  .rdc-mobile-modal__content {
    max-width: 95%;
    max-height: 90%;
    position: relative;
  }
  
  .rdc-mobile-modal__image {
    max-width: 100%;
    max-height: 85vh;
    border-radius: 5px;
    object-fit: contain;
  }
  
  .rdc-mobile-modal__caption {
    text-align: center;
    color: #333;
    font-size: 14px;
    margin-top: 1rem;
    padding: 0 1rem;
    line-height: 1.5;
  }
  
  .rdc-mobile-modal__close {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgb(255, 255, 255);
    border: 2px solid #EEEDE6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    font-size: 28px;
    line-height: 1;
  }
</style>

<div class="rdc-mobile-gallery" id="RdcMobileGallery-{{ section.id }}">
  <!-- Main image display -->
  <div class="rdc-mobile-gallery__main">
    <img 
      class="rdc-mobile-gallery__main-image" 
      id="RdcMobileMainImage-{{ section.id }}"
      src="{{ featured_media | image_url: width: 1200 }}"
      alt="{{ featured_media.alt | escape }}"
      data-resume="{%- if product.type != blank -%}{%- assign product_type_lower = product.type | downcase | strip -%}{%- for produit in shop.metaobjects.produits.values -%}{%- assign produit_nom = produit.nom.value | downcase | strip -%}{%- if produit_nom == product_type_lower -%}Modèle<b> « {{ produit.nom.value }} »</b>{% if produit.type != blank %} {{ produit.type.value | downcase }}{% endif %}{% if produit.coupe != blank %} {{ produit.coupe.value | downcase }}{% endif %}{% if produit.tissu != blank %} {{ produit.tissu.value | join: ', ' | downcase }}{% endif %}{%- break -%}{%- endif -%}{%- endfor -%}{%- endif -%}"
      data-product-title="{{ product.title | escape }}"
    >
    <div class="rdc-mobile-gallery__counter" id="RdcMobileCounter-{{ section.id }}">
      <span class="current">1</span>/<span class="total">{{ media_count }}</span>
    </div>
  </div>

  <!-- Thumbnail navigation on the right -->
  <div class="rdc-mobile-gallery__thumbnails" id="RdcMobileThumbnails-{{ section.id }}">
    {%- for media in product.media -%}
      {%- if media.media_type == 'image' -%}
        {%- assign variant_ids = '' -%}
        {%- assign is_featured = false -%}
        {%- for variant in product.variants -%}
          {%- if variant.featured_media.id == media.id -%}
            {%- assign is_featured = true -%}
            {%- if variant_ids == '' -%}
              {%- assign variant_ids = variant.id | append: '' -%}
            {%- else -%}
              {%- assign variant_ids = variant_ids | append: ',' | append: variant.id -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        
        <div 
          class="rdc-mobile-gallery__thumb {% if media.id == featured_media.id %}active{% endif %}"
          data-media-id="{{ media.id }}"
          data-index="{{ forloop.index0 }}"
          data-image-src="{{ media.src | split: '/' | last }}"
          data-variant-ids="{{ variant_ids }}"
          data-is-featured="{{ is_featured }}"
          data-full-src="{{ media | image_url: width: 1200 }}"
          data-alt="{{ media.alt | escape }}"
          data-resume="{%- if product.type != blank -%}{%- assign product_type_lower = product.type | downcase | strip -%}{%- for produit in shop.metaobjects.produits.values -%}{%- assign produit_nom = produit.nom.value | downcase | strip -%}{%- if produit_nom == product_type_lower -%}Modèle<b> « {{ produit.nom.value }} »</b>{% if produit.type != blank %} {{ produit.type.value | downcase }}{% endif %}{% if produit.coupe != blank %} {{ produit.coupe.value | downcase }}{% endif %}{% if produit.tissu != blank %} {{ produit.tissu.value | join: ', ' | downcase }}{% endif %}{%- break -%}{%- endif -%}{%- endfor -%}{%- endif -%}"
          data-product-title="{{ product.title | escape }}"
        >
          {{
            media
            | image_url: width: 200
            | image_tag:
              loading: 'lazy',
              alt: media.alt | escape
          }}
        </div>
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>

<!-- Caption below gallery -->
<div class="rdc-mobile-gallery__caption" id="RdcMobileCaption-{{ section.id }}"></div>

<!-- Zoom Modal for mobile -->
<div class="rdc-mobile-modal" id="RdcMobileModal-{{ section.id }}">
  <button class="rdc-mobile-modal__close" id="RdcMobileModalClose-{{ section.id }}">&times;</button>
  <div class="rdc-mobile-modal__content">
    <img class="rdc-mobile-modal__image" id="RdcMobileModalImage-{{ section.id }}" src="" alt="">
    <p class="rdc-mobile-modal__caption" id="RdcMobileModalCaption-{{ section.id }}"></p>
  </div>
</div>

<script>
  (function() {
    function initMobileGallery() {
      const gallery = document.getElementById('RdcMobileGallery-{{ section.id }}');
      if (!gallery) return;

      const mainImage = document.getElementById('RdcMobileMainImage-{{ section.id }}');
      const caption = document.getElementById('RdcMobileCaption-{{ section.id }}');
      const counter = document.getElementById('RdcMobileCounter-{{ section.id }}');
      const thumbnails = Array.from(document.querySelectorAll('#RdcMobileThumbnails-{{ section.id }} .rdc-mobile-gallery__thumb'));
      const modal = document.getElementById('RdcMobileModal-{{ section.id }}');
      const modalImage = document.getElementById('RdcMobileModalImage-{{ section.id }}');
      const modalCaption = document.getElementById('RdcMobileModalCaption-{{ section.id }}');
      const modalClose = document.getElementById('RdcMobileModalClose-{{ section.id }}');

      // Update caption based on current image
      function updateCaption() {
        const altText = (mainImage.alt || '').trim();
        const resume = mainImage.dataset.resume || '';
        const productTitle = mainImage.dataset.productTitle || '';
        
        let captionText = resume;
        if (altText && altText !== productTitle) {
          captionText = altText;
        }
        
        caption.innerHTML = captionText;
      }

      // Update counter
      function updateCounter() {
        const visibleThumbs = thumbnails.filter(thumb => thumb.style.display !== 'none');
        const activeIndex = visibleThumbs.findIndex(thumb => thumb.classList.contains('active'));
        counter.querySelector('.current').textContent = activeIndex + 1;
        counter.querySelector('.total').textContent = visibleThumbs.length;
      }

      // Get selected color name
      function getSelectedColorName() {
        const variantRadios = document.querySelectorAll('variant-radios input[type="radio"]:checked, .product-form__input input[type="radio"]:checked');
        
        for (const radio of variantRadios) {
          const fieldset = radio.closest('fieldset');
          
          if (fieldset) {
            const hasColorClass = fieldset.classList.contains('product-form__input--color');
            const legend = fieldset.querySelector('legend');
            const legendText = legend?.textContent.toLowerCase() || '';
            const hasColorLegend = legendText.includes('couleur') || legendText.includes('color');
            
            if (hasColorClass || hasColorLegend) {
              const label = document.querySelector(`label[for="${radio.id}"]`);
              let colorName = label?.textContent.trim() || '';
              colorName = colorName.replace(/Variante épuisée ou indisponible/gi, '').replace(/Épuisé/gi, '').trim();
              const parts = colorName.split(':');
              return parts.length > 1 ? parts[1].trim() : colorName;
            }
          }
        }
        
        return '';
      }

      // Get selected variant ID
      function getSelectedVariantId() {
        const variantIdInput = document.querySelector('input[name="id"]');
        return variantIdInput ? variantIdInput.value : null;
      }

      // Filter thumbnails by color
      function filterByColor() {
        const colorName = getSelectedColorName().toLowerCase();
        const selectedVariantId = getSelectedVariantId();
        
        if (!colorName) {
          thumbnails.forEach(thumb => thumb.style.display = '');
        } else {
          thumbnails.forEach(thumb => {
            const imageSrc = (thumb.dataset.imageSrc || '').toLowerCase();
            const isFeatured = thumb.dataset.isFeatured === 'true';
            const variantIds = thumb.dataset.variantIds || '';
            const matchesVariant = selectedVariantId && variantIds.split(',').includes(String(selectedVariantId));
            
            const hasColorInName = imageSrc.includes(colorName);
            const isFeaturedForVariant = isFeatured && matchesVariant;
            const hasTotal = imageSrc.includes('total');
            
            thumb.style.display = (hasColorInName || isFeaturedForVariant || hasTotal) ? '' : 'none';
          });
        }

        // Set first visible thumbnail as active
        const firstVisible = thumbnails.find(thumb => thumb.style.display !== 'none');
        if (firstVisible) {
          thumbnails.forEach(thumb => thumb.classList.remove('active'));
          firstVisible.classList.add('active');
          mainImage.src = firstVisible.dataset.fullSrc;
          mainImage.alt = firstVisible.dataset.alt;
          mainImage.dataset.resume = firstVisible.dataset.resume;
          mainImage.dataset.productTitle = firstVisible.dataset.productTitle;
          updateCaption();
          updateCounter();
        }
      }

      // Thumbnail click handler
      thumbnails.forEach(thumb => {
        thumb.addEventListener('click', function() {
          if (thumb.style.display === 'none') return;
          
          thumbnails.forEach(t => t.classList.remove('active'));
          thumb.classList.add('active');
          
          mainImage.src = thumb.dataset.fullSrc;
          mainImage.alt = thumb.dataset.alt;
          mainImage.dataset.resume = thumb.dataset.resume;
          mainImage.dataset.productTitle = thumb.dataset.productTitle;
          
          updateCaption();
          updateCounter();
        });
      });

      // Main image click to open zoom modal
      mainImage.addEventListener('click', function() {
        modalImage.src = mainImage.src.replace(/_(small|compact|medium|large|grande|pico|icon|thumb|1024x1024|master)\./, '_2048x2048.');
        modalImage.alt = mainImage.alt;
        
        const altText = (mainImage.alt || '').trim();
        const resume = mainImage.dataset.resume || '';
        const productTitle = mainImage.dataset.productTitle || '';
        
        let captionText = resume;
        if (altText && altText !== productTitle) {
          captionText = altText;
        }
        
        modalCaption.innerHTML = captionText;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      // Close modal
      function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      modalClose.addEventListener('click', closeModal);
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeModal();
        }
      });

      // Listen for variant changes
      document.addEventListener('change', function(event) {
        if (event.target.matches('input[type="radio"]')) {
          setTimeout(filterByColor, 50);
        }
      });

      // Initial setup
      updateCaption();
      updateCounter();
      setTimeout(filterByColor, 100);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileGallery);
    } else {
      initMobileGallery();
    }
  })();
</script>
