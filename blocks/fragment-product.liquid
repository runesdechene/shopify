{%- doc -%}
  Fragment Product Block
  
  Renders product information (name, price) from a product linked to the fragment.
  Supports random product selection from linked products.
  
  @param {object} closest.fragment - The fragment metaobject
{%- enddoc -%}

{% liquid
  assign fragment = closest.metaobject.illustrations
  assign block_settings = block.settings
  
  assign selected_product = nil
  
  if fragment != blank
    # Get linked products from the metaobject's "produits" field
    assign linked_products = fragment.produits.value
    
    if linked_products != blank and linked_products.size > 0
      if block_settings.random_product
        assign random_index = 'now' | date: '%S' | modulo: linked_products.size
        assign selected_product = linked_products[random_index]
      else
        assign selected_product = linked_products.first
      endif
    endif
  endif
  
  assign onboarding = false
  if selected_product == blank
    assign onboarding = true
    assign product_title = 'placeholders.product_title' | t
    assign product_price = '29,99 â‚¬'
  else
    assign product_title = selected_product.title
    if settings.currency_code_enabled_product_cards
      assign product_price = selected_product.price | money_with_currency
    else
      assign product_price = selected_product.price | money
    endif
  endif
%}

<div 
  class="fragment-product"
  style="
    --fragment-product-gap: {{ block_settings.gap }}px;
    text-align: {{ block_settings.alignment }};
  "
  {{ block.shopify_attributes }}
>
  {% if block_settings.show_title %}
    <div class="fragment-product__title">
      {% if onboarding %}
        <span>{{ product_title }}</span>
      {% else %}
        <a href="{{ selected_product.url }}" class="fragment-product__link">
          {{ product_title }}
        </a>
      {% endif %}
    </div>
  {% endif %}
  
  {% if block_settings.show_price %}
    <div class="fragment-product__price">
      {{ product_price }}
    </div>
  {% endif %}
</div>

{% stylesheet %}
  .fragment-product {
    display: flex;
    flex-direction: column;
    gap: var(--fragment-product-gap, 4px);
  }
  
  .fragment-product__title {
    font-weight: var(--font-weight-semibold);
  }
  
  .fragment-product__link {
    color: inherit;
    text-decoration: none;
  }
  
  .fragment-product__link:hover {
    text-decoration: underline;
  }
  
  .fragment-product__price {
    color: var(--color-foreground-secondary);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.fragment_product",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "t:settings.show_product_title",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "t:settings.show_price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "random_product",
      "label": "t:settings.random_product",
      "info": "t:info.random_product",
      "default": false
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 4
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "t:settings.alignment",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "center",
          "label": "t:options.center"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 8
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ]
}
{% endschema %}
