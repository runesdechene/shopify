{%- doc -%}
  Fragment Card Image Block
  
  Renders the image for a fragment card, using the first product image
  from a product linked to this fragment metaobject.
  
  @param {object} closest.fragment - The fragment metaobject
{%- enddoc -%}

{% liquid
  assign block_settings = block.settings
  
  assign image = nil
  assign alt = ''
  assign selected_product = nil
  
  if fragment != blank
    # Try to get linked products from the metaobject's "produits" field
    assign linked_products = fragment.produits.value
    
    if linked_products != blank and linked_products.size > 0
      if block_settings.random_product
        assign random_index = 'now' | date: '%S' | modulo: linked_products.size
        assign selected_product = linked_products[random_index]
      else
        assign selected_product = linked_products.first
      endif
      assign image = selected_product.featured_image
      assign alt = selected_product.title
    endif
  endif
%}

{% if image != blank %}
  {% render 'resource-image',
    content_type: 'fragments',
    image_source: image,
    alt: alt,
    block: block,
    section: section
  %}
{% else %}
  <div class="fragment-card__image fragment-card__image--placeholder">
    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
  </div>
{% endif %}

{% schema %}
{
  "name": "t:names.fragment_card_image",
  "settings": [
    {
      "type": "select",
      "id": "image_ratio",
      "label": "t:settings.image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:options.adapt"
        },
        {
          "value": "square",
          "label": "t:options.square"
        },
        {
          "value": "portrait",
          "label": "t:options.portrait"
        },
        {
          "value": "landscape",
          "label": "t:options.landscape"
        }
      ],
      "default": "square"
    },
    {
      "type": "checkbox",
      "id": "random_product",
      "label": "t:settings.random_product",
      "info": "t:info.random_product",
      "default": false
    },
    {
      "type": "header",
      "content": "t:content.overlay"
    },
    {
      "type": "checkbox",
      "id": "toggle_overlay",
      "label": "t:settings.toggle_overlay",
      "default": false
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "t:settings.overlay_color",
      "default": "#00000026",
      "visible_if": "{{ block.settings.toggle_overlay == true }}"
    },
    {
      "type": "select",
      "id": "overlay_style",
      "label": "t:settings.overlay_style",
      "options": [
        {
          "value": "solid",
          "label": "t:options.solid"
        },
        {
          "value": "gradient",
          "label": "t:options.gradient"
        }
      ],
      "default": "solid",
      "visible_if": "{{ block.settings.toggle_overlay == true }}"
    },
    {
      "type": "select",
      "id": "gradient_direction",
      "label": "t:settings.gradient_direction",
      "options": [
        {
          "value": "to top",
          "label": "t:options.to_top"
        },
        {
          "value": "to bottom",
          "label": "t:options.to_bottom"
        }
      ],
      "default": "to top",
      "visible_if": "{{ block.settings.overlay_style == 'gradient' and block.settings.toggle_overlay == true }}"
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "select",
      "id": "border",
      "label": "t:settings.borders",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "solid",
          "label": "t:options.solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 10,
      "step": 0.5,
      "unit": "px",
      "label": "t:settings.border_width",
      "default": 1,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "t:settings.border_opacity",
      "default": 100,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "t:settings.border_radius",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ]
}
{% endschema %}
