{%- assign block_settings = block.settings -%}

<div
  class="countdown-block countdown-block--{{ block.id }}"
  data-countdown
  data-countdown-id="{{ block.id }}"
  style="
    --countdown-gap: {{ block_settings.gap }}px;
    --countdown-alignment: {{ block_settings.alignment }};
  "
  {{ block.shopify_attributes }}
>
  {% if block_settings.heading != blank %}
    <div class="countdown-block__heading">
      <div class="countdown-heading">
        {% if block_settings.icon != blank %}
          <span class="countdown-icon">
            {{ block_settings.icon | image_url: width: 40 | image_tag: loading: 'lazy', alt: '' }}
          </span>
        {% endif %}
        <p class="countdown-heading-text">{{ block_settings.heading }}</p>
      </div>
    </div>
  {% endif %}

  <div class="countdown-block__timer">
    <div class="countdown-unit">
      <span class="countdown-value" data-countdown-days>00</span>
      <span class="countdown-label">{{ block_settings.label_days | default: 'Jours' }}</span>
    </div>
    <div class="countdown-separator">:</div>
    <div class="countdown-unit">
      <span class="countdown-value" data-countdown-hours>00</span>
      <span class="countdown-label">{{ block_settings.label_hours | default: 'Heures' }}</span>
    </div>
    <div class="countdown-separator">:</div>
    <div class="countdown-unit">
      <span class="countdown-value" data-countdown-minutes>00</span>
      <span class="countdown-label">{{ block_settings.label_minutes | default: 'Minutes' }}</span>
    </div>
    <div class="countdown-separator">:</div>
    <div class="countdown-unit">
      <span class="countdown-value" data-countdown-seconds>00</span>
      <span class="countdown-label">{{ block_settings.label_seconds | default: 'Secondes' }}</span>
    </div>
  </div>

  {% if block_settings.message != blank %}
    <div class="countdown-block__message">
      <p class="countdown-message">{{ block_settings.message }}</p>
    </div>
  {% endif %}
</div>

{% stylesheet %}
  .countdown-block {
    display: flex;
    flex-direction: column;
    align-items: var(--countdown-alignment, center);
    gap: var(--countdown-gap, 16px);
    padding: 20px;
    background: #ece7d9;
    border-radius: 20px;
    border-radius: 20px;
  }

  .countdown-block__heading {
    text-align: center;
  }

  .countdown-heading {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3rem;
    font-weight: 400;
    text-transform: uppercase;
    font-family: var(--font-heading--family);
  }

  .countdown-heading-text {
    margin: 0;
  }

  .countdown-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    opacity: 0.8;
  }

  .countdown-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .countdown-block__timer {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: nowrap;
    justify-content: center;
  }

  .countdown-unit {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    min-width: 60px;
  }

  .countdown-value {
    font-size: 2.2rem;
    font-weight: 700;
    line-height: 1;
    font-variant-numeric: tabular-nums;
    font-family: var(--font-accent--family);
    color: #833434;
  }

  .countdown-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.7;
  }

  .countdown-separator {
    font-size: 1.4rem;
    font-weight: 700;
    line-height: 1;
    opacity: 0.5;
  }

  .countdown-block__message {
    text-align: right;
    max-width: 300px;
  }

  .countdown-message {
    font-size: 0.875rem;
    margin: 0;
    opacity: 0.8;
  }

  @media screen and (max-width: 749px) {
    .countdown-value {
      font-size: 2rem;
    }

    .countdown-separator {
      font-size: 1.5rem;
    }

    .countdown-unit {
      min-width: 50px;
    }
  }
{% endstylesheet %}

{% javascript %}
  class CountdownTimer {
    constructor(element) {
      this.element = element;
      this.daysEl = element.querySelector('[data-countdown-days]');
      this.hoursEl = element.querySelector('[data-countdown-hours]');
      this.minutesEl = element.querySelector('[data-countdown-minutes]');
      this.secondsEl = element.querySelector('[data-countdown-seconds]');
      this.interval = null;

      // Récupérer les settings globaux depuis window.Shopify.theme.settings
      this.mode = window.Shopify?.theme?.settings?.countdown_mode || 'mondays';
      this.recurrenceDays = parseInt(window.Shopify?.theme?.settings?.countdown_recurrence_days) || 14;
      this.startDate = window.Shopify?.theme?.settings?.countdown_start_date || '2026-02-03';

      this.init();
    }

    init() {
      this.calculateNextDeadline();
      this.updateDisplay();
      this.startTimer();
    }

    calculateNextDeadline() {
      if (this.mode === 'mondays') {
        this.calculateNextMonday();
      } else {
        this.calculateNextCustomDate();
      }
    }

    calculateNextMonday() {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      // Trouver le prochain 1er ou 3ème lundi du mois
      const firstMonday = this.getNthMondayOfMonth(currentYear, currentMonth, 1);
      const thirdMonday = this.getNthMondayOfMonth(currentYear, currentMonth, 3);

      // Déterminer quelle échéance est la prochaine
      if (now < firstMonday) {
        this.deadline = firstMonday;
      } else if (now < thirdMonday) {
        this.deadline = thirdMonday;
      } else {
        // Passer au mois suivant, prendre le 1er lundi
        const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
        const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
        this.deadline = this.getNthMondayOfMonth(nextYear, nextMonth, 1);
      }
    }

    calculateNextCustomDate() {
      const now = new Date();
      const start = new Date(this.startDate);

      // Calculer le nombre de jours depuis la date de départ
      const daysSinceStart = Math.floor((now - start) / (1000 * 60 * 60 * 24));

      // Calculer le nombre de cycles complets
      const cyclesPassed = Math.floor(daysSinceStart / this.recurrenceDays);

      // Calculer la prochaine date
      const nextCycle = cyclesPassed + 1;
      const daysToAdd = nextCycle * this.recurrenceDays;

      this.deadline = new Date(start);
      this.deadline.setDate(start.getDate() + daysToAdd);
      this.deadline.setHours(23, 59, 59, 999);
    }

    getNthMondayOfMonth(year, month, n) {
      const firstDay = new Date(year, month, 1);
      const firstDayOfWeek = firstDay.getDay();

      // Calculer le premier lundi (0 = dimanche, 1 = lundi)
      let daysUntilMonday = (8 - firstDayOfWeek) % 7;
      if (daysUntilMonday === 0) daysUntilMonday = 0;

      const firstMonday = 1 + daysUntilMonday;
      const nthMonday = firstMonday + (n - 1) * 7;

      return new Date(year, month, nthMonday, 23, 59, 59);
    }

    updateDisplay() {
      const now = new Date();
      const diff = this.deadline - now;

      if (diff <= 0) {
        // Recalculer la prochaine échéance
        this.calculateNextDeadline();
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      this.daysEl.textContent = String(days).padStart(2, '0');
      this.hoursEl.textContent = String(hours).padStart(2, '0');
      this.minutesEl.textContent = String(minutes).padStart(2, '0');
      this.secondsEl.textContent = String(seconds).padStart(2, '0');
    }

    startTimer() {
      this.interval = setInterval(() => {
        this.updateDisplay();
      }, 1000);
    }

    destroy() {
      if (this.interval) {
        clearInterval(this.interval);
      }
    }
  }

  // Initialiser tous les comptes à rebours
  document.addEventListener('DOMContentLoaded', () => {
    const countdowns = document.querySelectorAll('[data-countdown]');
    countdowns.forEach((countdown) => {
      new CountdownTimer(countdown);
    });
  });

  // Support pour le theme editor
  if (Shopify.designMode) {
    document.addEventListener('shopify:section:load', (event) => {
      const countdowns = event.target.querySelectorAll('[data-countdown]');
      countdowns.forEach((countdown) => {
        new CountdownTimer(countdown);
      });
    });
  }
{% endjavascript %}

{% schema %}
{
  "name": "Compte à rebours",
  "tag": "div",
  "settings": [
    {
      "type": "image_picker",
      "id": "icon",
      "label": "Icône",
      "info": "Icône affichée à gauche du titre (optionnel)"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Titre",
      "default": "Prochaine impression dans :"
    },
    {
      "type": "text",
      "id": "message",
      "label": "Message",
      "default": "Commandez maintenant pour la prochaine impression !",
      "info": "Message affiché sous le compte à rebours"
    },
    {
      "type": "header",
      "content": "Étiquettes"
    },
    {
      "type": "text",
      "id": "label_days",
      "label": "Jours",
      "default": "Jours"
    },
    {
      "type": "text",
      "id": "label_hours",
      "label": "Heures",
      "default": "Heures"
    },
    {
      "type": "text",
      "id": "label_minutes",
      "label": "Minutes",
      "default": "Minutes"
    },
    {
      "type": "text",
      "id": "label_seconds",
      "label": "Secondes",
      "default": "Secondes"
    },
    {
      "type": "header",
      "content": "Mise en page"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Alignement",
      "options": [
        {
          "value": "flex-start",
          "label": "Gauche"
        },
        {
          "value": "center",
          "label": "Centre"
        },
        {
          "value": "flex-end",
          "label": "Droite"
        }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Espacement",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Compte à rebours"
    }
  ]
}
{% endschema %}
